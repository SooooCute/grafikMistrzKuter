<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KUTER - System Grafik</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase (Compat) - –°—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- –®—Ä–∏—Ñ—Ç—ã -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        @media print {
            .no-print { display: none !important; }
            .print-show { display: block !important; }
            body { background: white; }
            .card { box-shadow: none; border: 1px solid #ddd; }
            table { width: 100%; font-size: 11px; border-collapse: collapse; }
            th, td { border: 1px solid #000 !important; padding: 2px !important; }
        }
        .print-show { display: none; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1e293b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800">
    <div id="root"></div>

    <!-- –ë–ª–æ–∫ –¥–ª—è –æ—Ç–ª–æ–≤–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const errDiv = document.createElement('div');
            errDiv.style.cssText = 'color:red; background:white; padding:20px; border:2px solid red; margin:20px; z-index:9999; position:relative;';
            errDiv.innerHTML = '<h3>Critical Error:</h3><p>' + message + '</p><p>Line: ' + lineno + '</p>';
            document.body.prepend(errDiv);
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDPIZCV4h6Crh254OtZExUaLQtAgjWS1iM",
            authDomain: "grafikmistrz.firebaseapp.com",
            projectId: "grafikmistrz",
            storageBucket: "grafikmistrz.firebasestorage.app",
            messagingSenderId: "605834476831",
            appId: "1:605834476831:web:8da87595b0acb2beb7c42a"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        let app, auth, db;
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            auth = firebase.auth();
            db = firebase.firestore();
            console.log("Firebase OK");
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // --- –¢–ï–ö–°–¢–´ ---
        const TEXT = {
            appName: "KUTER",
            appSub: "Sma≈ºalnia & Grill",
            tabStaff: "Zesp√≥≈Ç",
            tabCalendar: "Grafik",
            tabStats: "Raporty",
            secWaiters: "Obs≈Çuga (Kelnerzy)",
            secBartenders: "Barmani",
            addBtn: "Dodaj pracownika",
            namePlaceholder: "Imiƒô i nazwisko...",
            genBtn: "Generuj Grafik",
            exportCsv: "Eksport Excel (CSV)",
            printBtn: "Drukuj",
            dateCol: "Data",
            barCol: "Bar",
            morningCol: "Rano (10:00)",
            eveningCol: "Popo≈Çudnie (12:00)",
            loginTitle: "Panel Pracowniczy",
            btnLogin: "Zaloguj",
            btnRegister: "Rejestracja",
            btnLogout: "Wyloguj",
            emailLabel: "Email",
            passLabel: "Has≈Ço",
            archive: "Archiwizuj",
            genSettings: "Konfiguracja Zmian",
            totalStaff: "Obs≈Çuga ≈ÇƒÖcznie:",
            morningStaff: "W tym rano:",
            cancel: "Anuluj",
            generate: "Start",
            deleteConfirm: "Czy zarchiwizowaƒá pracownika?",
            deleteSub: "Zniknie z listy aktywnej, ale zostanie w historii.",
            errorAuth: "B≈ÇƒÖd logowania. Sprawd≈∫ dane."
        };

        // --- –ß–ê–°–´ ---
        function LiveClock() {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            return (
                <div className="flex flex-col items-end">
                    <div className="text-3xl font-bold text-amber-400 leading-none drop-shadow-md" style={{fontFamily: 'monospace'}}>
                        {time.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                    <div className="text-xs font-bold text-slate-300 uppercase tracking-wider mt-1">
                        {time.toLocaleDateString('pl-PL', { weekday: 'long', day: 'numeric', month: 'long' })}
                    </div>
                </div>
            );
        }

        // --- APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [people, setPeople] = useState([]);
            const [schedule, setSchedule] = useState({});
            const [holidays, setHolidays] = useState([]);
            
            const [activeTab, setActiveTab] = useState('staff');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [loading, setLoading] = useState(true);
            
            const [newName, setNewName] = useState('');
            const [newGender, setNewGender] = useState('male');
            const [newRole, setNewRole] = useState('waiter');
            const [addingToSlot, setAddingToSlot] = useState(null);
            const [personToRemove, setPersonToRemove] = useState(null);
            const [genSettings, setGenSettings] = useState(null);

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(u => {
                    setUser(u);
                    setIsAuthReady(true);
                    if(!u) { setPeople([]); setSchedule({}); }
                }, error => {
                    console.error("Auth State Error:", error);
                    setIsAuthReady(true);
                });
                return () => unsub();
            }, []);

            useEffect(() => {
                if(!user || !db) return;
                setLoading(true);
                const ref = `artifacts/${firebaseConfig.projectId}/users/${user.uid}`;
                
                const unsubPeople = db.collection(`${ref}/people`).onSnapshot(snap => {
                    setPeople(snap.docs.map(d => ({id: d.id, ...d.data()})));
                    setLoading(false);
                }, err => console.error("People Error", err));
                
                const unsubSched = db.doc(`${ref}/appData/schedule`).onSnapshot(snap => {
                    setSchedule(snap.data() || {});
                }, err => console.error("Schedule Error", err));
                
                const unsubHol = db.doc(`${ref}/appData/holidays`).onSnapshot(snap => {
                    setHolidays(snap.data()?.dates || []);
                }, err => console.error("Holiday Error", err));
                
                return () => { unsubPeople(); unsubSched(); unsubHol(); };
            }, [user]);

            const getPerson = (id) => people.find(p => p.id === id);
            const getUserRef = () => `artifacts/${firebaseConfig.projectId}/users/${user.uid}`;
            const getMonthName = (d) => d.toLocaleString('pl-PL', { month: 'long', year: 'numeric' });
            const changeMonth = (d) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(newDate.getMonth() + d);
                setCurrentDate(newDate);
            };

            const getBarmanArray = (shift) => {
                if (!shift || !shift.barman) return [];
                if (Array.isArray(shift.barman)) return shift.barman;
                return [shift.barman];
            };

            const stats = useMemo(() => {
                const s = {};
                people.forEach(p => s[p.id] = { h: 0, covers: 0 });
                const daysInM = new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate();
                
                for(let i=1; i<=daysInM; i++) {
                    const dObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                    const dStr = dObj.toLocaleDateString('en-CA');
                    const dayOfWeek = dObj.getDay();
                    const shift = schedule[dStr];
                    
                    if(shift) {
                        const barmen = getBarmanArray(shift);
                        barmen.forEach((bid, index) => {
                            if(s[bid]) {
                                let hours = 12;
                                if (dayOfWeek === 5 && index > 0) hours = 7; 
                                else if (dayOfWeek === 0 && index > 0) hours = 6; 
                                s[bid].h += hours;
                                if(getPerson(bid)?.role === 'waiter') s[bid].covers++;
                            }
                        });
                        shift.morning.forEach(id => { if(s[id]) s[id].h += 10; });
                        shift.evening.forEach(id => { if(s[id]) s[id].h += 12; });
                    }
                }
                return s;
            }, [people, schedule, currentDate]);

            const getStreak = (pid, dateStr) => {
                const d = new Date(dateStr);
                let streak = 0;
                for(let i=1; i<=5; i++) {
                    const prev = new Date(d);
                    prev.setDate(d.getDate() - i);
                    const pStr = prev.toLocaleDateString('en-CA');
                    const s = schedule[pStr];
                    if(s) {
                        const barmen = getBarmanArray(s);
                        if (barmen.includes(pid) || s.morning.includes(pid) || s.evening.includes(pid)) streak++;
                        else break;
                    } else break;
                }
                return streak;
            };

            const addPerson = async () => {
                if(!newName.trim()) return;
                await db.collection(`${getUserRef()}/people`).add({
                    name: newName.trim(),
                    gender: newGender,
                    role: newRole,
                    daysOff: [],
                    archived: false
                });
                setNewName('');
            };

            const archivePerson = async () => {
                if(personToRemove) {
                    await db.doc(`${getUserRef()}/people/${personToRemove}`).update({ archived: true });
                    setPersonToRemove(null);
                }
            };

            const toggleDayOff = async (pid, day) => {
                const p = getPerson(pid);
                if(!p) return;
                const dateStr = new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toLocaleDateString('en-CA');
                const newOff = p.daysOff.includes(dateStr) 
                    ? p.daysOff.filter(d => d !== dateStr) 
                    : [...p.daysOff, dateStr];
                await db.doc(`${getUserRef()}/people/${pid}`).update({ daysOff: newOff });
            };

            const toggleHoliday = async (dateStr) => {
                const newHols = holidays.includes(dateStr) 
                    ? holidays.filter(d => d !== dateStr) 
                    : [...holidays, dateStr];
                await db.doc(`${getUserRef()}/appData/holidays`).set({ dates: newHols });
            };

            const removeFromShift = async (dateStr, type, personId) => {
                const shift = schedule[dateStr];
                if (!shift) return;
                let newShift = { ...shift };
                if (type === 'bar') {
                    const barmen = getBarmanArray(shift);
                    newShift.barman = barmen.filter(id => id !== personId);
                } else {
                    newShift[type] = shift[type].filter(id => id !== personId);
                }
                await db.doc(`${getUserRef()}/appData/schedule`).update({ [dateStr]: newShift });
            };

            const addToShift = async (dateStr, type, personId) => {
                const shift = schedule[dateStr] || { date: dateStr, morning: [], evening: [], barman: [] };
                let newShift = { ...shift };
                if (type === 'bar') {
                    const prev = getBarmanArray(shift);
                    newShift.barman = [...prev, personId];
                } else {
                    newShift[type] = [...(shift[type] || []), personId];
                }
                await db.doc(`${getUserRef()}/appData/schedule`).set({ [dateStr]: newShift }, { merge: true });
                setAddingToSlot(null);
            };

            // --- –í–û–¢ –û–ù–ê, –ü–û–¢–ï–†–Ø–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ---
            const openGenSettings = () => {
                const month = currentDate.getMonth();
                const isHighSeason = month >= 4 && month <= 8;
                setGenSettings({
                    show: true,
                    total: isHighSeason ? 6 : 4,
                    morning: isHighSeason ? 3 : 2
                });
            };

            const runGenerator = async () => {
                if(!genSettings) return;
                const { total, morning } = genSettings;
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysCount = new Date(year, month + 1, 0).getDate();
                
                let pool = people.filter(p => !p.archived).map(p => ({ ...p, hours: 0, streak: 0, barCount: 0 }));
                const newSched = {};

                const getScore = (p, role) => {
                    let s = p.hours;
                    if(p.streak >= 4) s += 1000; 
                    if(role === 'bartender' && p.role === 'waiter') s += (p.barCount * 50);
                    return s + Math.random() * 10;
                };

                for(let d = 1; d <= daysCount; d++) {
                    const dateObj = new Date(year, month, d);
                    const dateStr = dateObj.toLocaleDateString('en-CA');
                    const dayOfWeek = dateObj.getDay();
                    const available = pool.filter(p => !p.daysOff.includes(dateStr));
                    
                    let selectedBarmen = [];
                    let realBarmans = available.filter(p => p.role === 'bartender').sort((a,b) => getScore(a,'bartender') - getScore(b,'bartender'));
                    const isWeekendHigh = (dayOfWeek === 5 || dayOfWeek === 6 || dayOfWeek === 0);
                    const neededBarmen = isWeekendHigh ? 2 : 1;

                    while (selectedBarmen.length < neededBarmen && realBarmans.length > 0) {
                        selectedBarmen.push(realBarmans.shift());
                    }
                    if (selectedBarmen.length < neededBarmen) {
                        let waiterBarmans = available
                            .filter(p => p.role === 'waiter' && !selectedBarmen.includes(p))
                            .sort((a,b) => getScore(a,'bartender') - getScore(b,'bartender'));
                        while (selectedBarmen.length < neededBarmen && waiterBarmans.length > 0) {
                            const w = waiterBarmans.shift();
                            selectedBarmen.push(w);
                            pool.find(p => p.id === w.id).barCount++;
                        }
                    }
                    selectedBarmen.forEach((bm, idx) => {
                        const p = pool.find(x => x.id === bm.id);
                        let hours = 12; 
                        if (dayOfWeek === 5 && idx > 0) hours = 7; 
                        else if (dayOfWeek === 0 && idx > 0) hours = 6; 
                        p.hours += hours;
                        p.streak++;
                    });
                    const barmanIds = selectedBarmen.map(b => b.id);

                    let needed = total;
                    let mornNeeded = morning;
                    let waiterCands = available.filter(p => p.role === 'waiter' && !barmanIds.includes(p.id));
                    const barHasMale = selectedBarmen.some(b => b.gender === 'male');
                    let selectedWaiters = [];

                    if(!barHasMale) {
                        const males = waiterCands.filter(w => w.gender === 'male').sort((a,b) => getScore(a,'waiter') - getScore(b,'waiter'));
                        if(males.length > 0 && males[0].streak < 5) {
                            selectedWaiters.push(males[0]);
                            waiterCands = waiterCands.filter(x => x.id !== males[0].id);
                        }
                    }
                    waiterCands.sort((a,b) => getScore(a,'waiter') - getScore(b,'waiter'));
                    while(selectedWaiters.length < needed && waiterCands.length > 0) selectedWaiters.push(waiterCands.shift());

                    selectedWaiters.forEach(w => {
                        const p = pool.find(x => x.id === w.id);
                        p.hours += 10.5;
                        p.streak++;
                    });

                    const workedIds = [...barmanIds, ...selectedWaiters.map(w=>w.id)];
                    pool.forEach(p => { if(!workedIds.includes(p.id)) p.streak = 0; });

                    selectedWaiters.sort((a,b) => a.hours - b.hours);
                    const morningCrew = selectedWaiters.slice(0, mornNeeded).map(w => w.id);
                    const eveningCrew = selectedWaiters.slice(mornNeeded).map(w => w.id);

                    newSched[dateStr] = { barman: barmanIds, morning: morningCrew, evening: eveningCrew };
                }
                await db.doc(`${getUserRef()}/appData/schedule`).set(newSched, {merge: true});
                setGenSettings(null);
                setActiveTab('calendar');
            };

            const downloadCSV = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let csvContent = "\uFEFF"; 
                csvContent += "Data;Dzien;Swieto;Bar;Rano;Popoludnie\n";
                for (let day = 1; day <= daysInMonth; day++) {
                    const d = new Date(year, month, day);
                    const dateStr = d.toLocaleDateString('en-CA');
                    const dateDisplay = d.toLocaleDateString('pl-PL');
                    const dayName = d.toLocaleDateString('pl-PL', { weekday: 'long' });
                    const isHol = holidays.includes(dateStr) ? "TAK" : "";
                    const s = schedule[dateStr] || { morning: [], evening: [], barman: [] };
                    
                    const barmen = getBarmanArray(s);
                    const barNames = barmen.map(id => getPerson(id)?.name || "").join(", ");
                    const mornNames = s.morning.map(id => getPerson(id)?.name || "").join(", ");
                    const eveNames = s.evening.map(id => getPerson(id)?.name || "").join(", ");
                    csvContent += `${dateDisplay};${dayName};${isHol};${barNames};${mornNames};${eveNames}\n`;
                }
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `Grafik_KUTER_${year}_${month+1}.csv`;
                link.click();
            };

            // --- RENDER ---
            if(!isAuthReady) return <div className="flex h-screen items-center justify-center"><div className="loader"></div></div>;
            if(!user) return <AuthScreen />;
            
            return (
                <div className="min-h-screen flex flex-col">
                    {/* HEADER */}
                    <nav className="bg-slate-900 text-white shadow-lg no-print">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-20">
                                <div className="flex items-center gap-4">
                                    <div className="h-12 w-12 bg-slate-800 rounded-full flex items-center justify-center overflow-hidden border-2 border-slate-600">
                                        <img src="logo.jpg" alt="Kuter" className="h-full w-full object-cover" onError={(e)=>{e.target.style.display='none'}} />
                                        <span className="text-xs font-bold text-slate-400 absolute" style={{zIndex:-1}}>LOGO</span>
                                    </div>
                                    <div>
                                        <h1 className="text-xl font-bold tracking-wide text-white">{TEXT.appName}</h1>
                                        <p className="text-xs text-slate-400 tracking-widest uppercase">{TEXT.appSub}</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-6">
                                    <div className="hidden md:block text-right border-r border-slate-700 pr-6 mr-2">
                                        <LiveClock />
                                    </div>
                                    <div className="flex items-center gap-2 bg-slate-800 rounded-lg p-1">
                                        <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-slate-700 rounded text-slate-300 transition">‚óÄ</button>
                                        <span className="px-4 font-medium min-w-[140px] text-center capitalize">{getMonthName(currentDate)}</span>
                                        <button onClick={() => changeMonth(1)} className="p-2 hover:bg-slate-700 rounded text-slate-300 transition">‚ñ∂</button>
                                    </div>
                                    <button onClick={()=>auth.signOut()} className="text-slate-400 hover:text-white transition text-sm font-medium">{TEXT.btnLogout}</button>
                                </div>
                            </div>
                        </div>
                        <div className="bg-white border-b border-slate-200 text-slate-600">
                            <div className="max-w-7xl mx-auto px-4 flex gap-8">
                                {['staff', 'calendar', 'stats'].map(tab => (
                                    <button key={tab} onClick={() => setActiveTab(tab)}
                                        className={`py-4 font-medium border-b-2 transition ${activeTab === tab ? 'border-blue-900 text-blue-900' : 'border-transparent hover:text-slate-900'}`}
                                    >
                                        {tab === 'staff' && `üë• ${TEXT.tabStaff}`}
                                        {tab === 'calendar' && `üìÖ ${TEXT.tabCalendar}`}
                                        {tab === 'stats' && `üìä ${TEXT.tabStats}`}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    {/* MAIN CONTENT */}
                    <main className="flex-grow bg-slate-50 p-4 sm:p-8 max-w-7xl mx-auto w-full">
                        {activeTab === 'staff' && (
                            <div className="space-y-8">
                                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 no-print">
                                    <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><span className="bg-blue-100 text-blue-800 p-1 rounded">‚ûï</span> {TEXT.addBtn}</h2>
                                    <div className="flex flex-col sm:flex-row gap-3">
                                        <input value={newName} onChange={e=>setNewName(e.target.value)} placeholder={TEXT.namePlaceholder} className="flex-grow border border-slate-300 p-2.5 rounded-lg outline-none" />
                                        <select value={newGender} onChange={e=>setNewGender(e.target.value)} className="border border-slate-300 p-2.5 rounded-lg bg-white"><option value="male">Ch≈Çopak</option><option value="female">Dziewczyna</option></select>
                                        <select value={newRole} onChange={e=>setNewRole(e.target.value)} className="border border-slate-300 p-2.5 rounded-lg bg-white"><option value="waiter">Kelner</option><option value="bartender">Barman</option></select>
                                        <button onClick={addPerson} className="bg-blue-900 text-white px-6 py-2.5 rounded-lg font-medium hover:bg-blue-800 transition">Dodaj</button>
                                    </div>
                                </div>
                                <div className="grid md:grid-cols-2 gap-6">
                                    {[TEXT.secWaiters, TEXT.secBartenders].map((title, idx) => {
                                        const role = idx === 0 ? 'waiter' : 'bartender';
                                        const list = people.filter(p => p.role === role && !p.archived);
                                        return (
                                            <div key={role} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                                <div className="bg-slate-50 px-6 py-4 border-b border-slate-200 font-semibold text-slate-700">{title}</div>
                                                <div className="p-6 space-y-4">
                                                    {list.map(p => (
                                                        <div key={p.id} className="bg-white border border-slate-100 rounded-lg p-3 hover:border-blue-200 transition group">
                                                            <div className="flex justify-between items-center mb-3">
                                                                <div className="font-bold text-slate-800">{p.gender === 'male' ? 'üë®' : 'üë©'} {p.name}</div>
                                                                <button onClick={()=>setPersonToRemove(p.id)} className="text-slate-300 hover:text-red-500 transition no-print">üóëÔ∏è</button>
                                                            </div>
                                                            <div className="flex flex-wrap gap-1 no-print">
                                                                {Array.from({length: new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate()}, (_, i)=>i+1).map(d => {
                                                                    const dStr = new Date(currentDate.getFullYear(), currentDate.getMonth(), d).toLocaleDateString('en-CA');
                                                                    const isOff = p.daysOff.includes(dStr);
                                                                    const isWknd = new Date(currentDate.getFullYear(), currentDate.getMonth(), d).getDay() % 6 === 0;
                                                                    return (
                                                                        <button key={d} onClick={()=>toggleDayOff(p.id, d)} 
                                                                            className={`w-7 h-7 text-xs rounded font-medium transition ${isOff ? 'bg-red-500 text-white' : isWknd ? 'bg-slate-200 text-slate-600' : 'bg-slate-50 text-slate-400 hover:bg-blue-50 hover:text-blue-600'}`}>
                                                                            {d}
                                                                        </button>
                                                                    )
                                                                })}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                                <div className="text-right no-print">
                                    <button onClick={openGenSettings} className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow hover:bg-indigo-700">üîÑ {TEXT.genBtn}</button>
                                </div>
                            </div>
                        )}

                        {activeTab === 'calendar' && (
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 no-print">
                                    <div className="text-sm text-slate-500">‚ÑπÔ∏è Kliknij <span className="font-bold text-yellow-600">‚òÖ</span> aby oznaczyƒá ≈õwiƒôto.</div>
                                    <div className="flex gap-2">
                                        <button onClick={downloadCSV} className="bg-white border border-slate-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-50 text-slate-700">üì• {TEXT.exportCsv}</button>
                                        <button onClick={()=>window.print()} className="bg-white border border-slate-300 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-50 text-slate-700">üñ®Ô∏è {TEXT.printBtn}</button>
                                    </div>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="bg-slate-100 text-xs uppercase text-slate-500 tracking-wider">
                                                <th className="p-4 font-bold border-b border-slate-200 w-24">{TEXT.dateCol}</th>
                                                <th className="p-4 font-bold border-b border-slate-200 w-1/4 bg-indigo-50/50 text-indigo-900">{TEXT.barCol}</th>
                                                <th className="p-4 font-bold border-b border-slate-200 w-1/3 bg-orange-50/50 text-orange-900">{TEXT.morningCol}</th>
                                                <th className="p-4 font-bold border-b border-slate-200 w-1/3 bg-blue-50/50 text-blue-900">{TEXT.eveningCol}</th>
                                            </tr>
                                        </thead>
                                        <tbody className="text-sm text-slate-700 divide-y divide-slate-100">
                                            {Array.from({length: new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate()}, (_, i)=>i+1).map(d => {
                                                const dateObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), d);
                                                const dateStr = dateObj.toLocaleDateString('en-CA');
                                                const isHol = holidays.includes(dateStr);
                                                const isWknd = dateObj.getDay() % 6 === 0;
                                                const s = schedule[dateStr] || { barman: [], morning: [], evening: [] };
                                                
                                                const rowClass = isHol ? 'bg-red-50' : isWknd ? 'bg-slate-50' : '';

                                                const PersonBadge = ({uid, type, onDelete}) => {
                                                    const p = getPerson(uid);
                                                    if(!p) return null;
                                                    const isCover = type === 'bar' && p.role === 'waiter';
                                                    const streak = getStreak(uid, dateStr);
                                                    const isBurnout = streak >= 4;
                                                    
                                                    let bgClass = '';
                                                    if (type === 'bar') bgClass = isCover ? 'bg-yellow-100 text-yellow-900 border-yellow-300 ring-1 ring-yellow-300' : 'bg-indigo-100 text-indigo-800 border-indigo-200';
                                                    else if (type === 'morn') bgClass = 'bg-orange-100 text-orange-800 border-orange-200';
                                                    else bgClass = 'bg-blue-100 text-blue-800 border-blue-200';

                                                    return (
                                                        <span className={`inline-flex items-center px-2 py-1 rounded text-xs font-medium border mr-1 mb-1 ${bgClass}`}>
                                                            {p.name} {isCover && '‚ö†Ô∏è'} {isBurnout && 'üî•'}
                                                            <button onClick={onDelete} className="ml-1 text-slate-400 hover:text-red-600 no-print font-bold">√ó</button>
                                                        </span>
                                                    )
                                                };

                                                return (
                                                    <tr key={d} className={rowClass}>
                                                        <td className="p-3 align-top border-r border-slate-100 relative group">
                                                            <div className="font-bold text-lg leading-none">{d}</div>
                                                            <div className="text-xs text-slate-400 uppercase mt-1">{dateObj.toLocaleDateString('pl-PL', {weekday:'short'})}</div>
                                                            <button onClick={()=>toggleHoliday(dateStr)} className={`absolute top-3 right-2 text-lg no-print transition ${isHol ? 'opacity-100' : 'opacity-0 group-hover:opacity-50 grayscale hover:grayscale-0'}`}>‚òÖ</button>
                                                        </td>
                                                        {['bar', 'morning', 'evening'].map(role => {
                                                            const isBar = role === 'bar';
                                                            const userIds = isBar ? getBarmanArray(s) : (role === 'morning' ? s.morning : s.evening);
                                                            const bgColor = isBar ? 'bg-indigo-50/30' : role==='morning' ? 'bg-orange-50/30' : 'bg-blue-50/30';
                                                            
                                                            return (
                                                                <td key={role} className={`p-2 align-top ${bgColor} border-r border-slate-100 relative hover:bg-opacity-100 transition group/cell`}>
                                                                    <div className="min-h-[40px] flex flex-wrap">
                                                                        {userIds.map(uid => (
                                                                            <PersonBadge key={uid} uid={uid} type={isBar ? 'bar' : role==='morning' ? 'morn' : 'eve'} 
                                                                                onDelete={async ()=>{
                                                                                    const ns = {...s};
                                                                                    if(isBar) {
                                                                                        const prev = getBarmanArray(s);
                                                                                        ns.barman = prev.filter(x=>x!==uid);
                                                                                    }
                                                                                    else ns[role] = ns[role].filter(x=>x!==uid);
                                                                                    await db.doc(`${getUserRef()}/appData/schedule`).update({[dateStr]: ns});
                                                                                }} 
                                                                            />
                                                                        ))}
                                                                        <button className="absolute bottom-1 right-1 text-slate-300 hover:text-blue-600 no-print transition text-lg leading-none"
                                                                            onClick={()=>setAddingToSlot({date: dateStr, type: isBar ? 'bar' : role})}>
                                                                            ‚ûï
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            )
                                                        })}
                                                    </tr>
                                                )
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'stats' && (
                            <div className="grid md:grid-cols-2 gap-6">
                                {[TEXT.secWaiters, TEXT.secBartenders].map((title, idx) => {
                                    const role = idx === 0 ? 'waiter' : 'bartender';
                                    const maxHours = Math.max(...Object.values(stats).map(s=>s.h), 1);
                                    const list = people.filter(p => p.role === role && (!p.archived || stats[p.id]?.h > 0))
                                        .sort((a,b) => stats[b.id].h - stats[a.id].h);
                                    
                                    return (
                                        <div key={role} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                            <div className="bg-slate-50 px-6 py-3 border-b border-slate-200 font-bold text-slate-700">{title}</div>
                                            <div className="p-6 space-y-4">
                                                {list.map(p => (
                                                    <div key={p.id}>
                                                        <div className="flex justify-between text-sm mb-1 font-medium text-slate-700">
                                                            <span className={p.archived ? 'text-slate-400 line-through' : ''}>{p.name}</span>
                                                            <span>{stats[p.id].h}h {role==='waiter' && stats[p.id].covers > 0 && <span className="text-yellow-600 font-bold text-xs ml-1">({stats[p.id].covers} Bar)</span>}</span>
                                                        </div>
                                                        <div className="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                                                            <div className={`h-2.5 rounded-full ${role==='waiter'?'bg-blue-500':'bg-indigo-500'} ${p.archived?'opacity-50':''}`} 
                                                                style={{width: `${(stats[p.id].h / maxHours) * 100}%`}}></div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        )}
                    </main>

                    {/* SMART ADDING MODAL */}
                    {addingToSlot && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={()=>setAddingToSlot(null)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]" onClick={e=>e.stopPropagation()}>
                                <div className="p-4 bg-slate-50 border-b border-slate-100 font-bold text-slate-800 flex justify-between">
                                    <span>Dodaj: {addingToSlot.date} ({addingToSlot.type === 'bar' ? 'Bar' : addingToSlot.type === 'morning' ? 'Rano' : 'Popo≈Çudnie'})</span>
                                    <button onClick={()=>setAddingToSlot(null)}>‚úï</button>
                                </div>
                                <div className="overflow-y-auto p-2 flex-grow">
                                    {people.filter(p => !p.archived).map(p => {
                                        const s = schedule[addingToSlot.date];
                                        const barmen = s ? getBarmanArray(s) : [];
                                        const isWorking = s && (barmen.includes(p.id) || s.morning.includes(p.id) || s.evening.includes(p.id));
                                        if(isWorking) return null;

                                        const streak = getStreak(p.id, addingToSlot.date);
                                        const isBurnout = streak >= 4;
                                        const isDayOff = p.daysOff.includes(addingToSlot.date);
                                        
                                        const currentHours = stats[p.id]?.h || 0;
                                        let addedHours = 10;
                                        if (addingToSlot.type === 'bar' || addingToSlot.type === 'evening') addedHours = 12;
                                        const projectedHours = currentHours + addedHours;

                                        return (
                                            <button key={p.id} disabled={isDayOff}
                                                onClick={async ()=>{
                                                    const ns = {...(schedule[addingToSlot.date] || {barman:[], morning:[], evening:[]})};
                                                    if(addingToSlot.type === 'bar') {
                                                        const prev = getBarmanArray(ns);
                                                        ns.barman = [...prev, p.id];
                                                    }
                                                    else ns[addingToSlot.type] = [...ns[addingToSlot.type], p.id];
                                                    await db.doc(`${getUserRef()}/appData/schedule`).set({[addingToSlot.date]: ns}, {merge:true});
                                                    setAddingToSlot(null);
                                                }} 
                                                className={`w-full text-left px-4 py-3 mb-2 rounded-lg border flex justify-between items-center transition
                                                    ${isDayOff ? 'bg-red-50 border-red-100 opacity-60 cursor-not-allowed' : 'bg-white border-slate-100 hover:border-blue-300 hover:shadow-md'}
                                                `}>
                                                <div>
                                                    <div className="font-bold text-slate-800 flex items-center gap-2">
                                                        {p.name}
                                                        {isBurnout && <span title="Pracuje >4 dni z rzƒôdu!" className="text-lg">üî•</span>}
                                                        {p.role === 'waiter' && addingToSlot.type === 'bar' && <span className="text-xs bg-yellow-100 text-yellow-800 px-1.5 rounded">Zastƒôpstwo</span>}
                                                    </div>
                                                    <div className="text-xs text-slate-500 mt-0.5">
                                                        Godziny: {currentHours}h <span className="text-blue-600 font-bold">‚ûù ~{projectedHours}h</span>
                                                    </div>
                                                </div>
                                                {isDayOff ? (
                                                    <span className="text-xs bg-red-100 text-red-700 px-2 py-1 rounded font-bold uppercase">Urlop / Wolne</span>
                                                ) : (
                                                    <span className="text-blue-600 font-bold text-xl">+</span>
                                                )}
                                            </button>
                                        )
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* GEN SETTINGS MODAL */}
                    {genSettings?.show && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={()=>setGenSettings(null)}>
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-slate-800 mb-6">{TEXT.genSettings}</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">{TEXT.totalStaff}</label>
                                        <input type="number" value={genSettings.total} onChange={e=>setGenSettings({...genSettings, total: parseInt(e.target.value)})} 
                                            className="w-full border border-slate-300 rounded-lg p-3 text-lg font-semibold text-center" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">{TEXT.morningStaff}</label>
                                        <input type="number" value={genSettings.morning} onChange={e=>setGenSettings({...genSettings, morning: parseInt(e.target.value)})}
                                            className="w-full border border-slate-300 rounded-lg p-3 text-lg font-semibold text-center" />
                                    </div>
                                </div>
                                <div className="flex gap-3 mt-8">
                                    <button onClick={()=>setGenSettings(null)} className="flex-1 py-3 text-slate-600 font-medium hover:bg-slate-100 rounded-xl">{TEXT.cancel}</button>
                                    <button onClick={runGenerator} className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition">{TEXT.generate}</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ARCHIVE CONFIRM MODAL */}
                    {personToRemove && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={()=>setPersonToRemove(null)}>
                            <div className="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl text-center" onClick={e=>e.stopPropagation()}>
                                <h3 className="font-bold text-lg text-slate-800 mb-2">{TEXT.deleteConfirm}</h3>
                                <p className="text-slate-500 text-sm mb-6">{TEXT.deleteSub}</p>
                                <div className="flex gap-3">
                                    <button onClick={()=>setPersonToRemove(null)} className="flex-1 bg-slate-100 text-slate-700 py-2 rounded-lg font-medium">{TEXT.cancel}</button>
                                    <button onClick={archivePerson} className="flex-1 bg-red-600 text-white py-2 rounded-lg font-medium hover:bg-red-700">{TEXT.archive}</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function AuthScreen() {
            const [isReg, setIsReg] = useState(false);
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const [err, setErr] = useState('');
            const [busy, setBusy] = useState(false);

            const handle = async (e) => {
                e.preventDefault();
                setBusy(true); setErr('');
                try {
                    if(isReg) await auth.createUserWithEmailAndPassword(email, pass);
                    else await auth.signInWithEmailAndPassword(email, pass);
                } catch(e) {
                    console.error(e);
                    setErr(TEXT.errorAuth);
                    setBusy(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4 font-sans">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-200">
                        <div className="text-center mb-8">
                            <h1 className="text-2xl font-bold text-slate-800">KUTER</h1>
                            <p className="text-slate-500">{TEXT.loginTitle}</p>
                        </div>
                        <form onSubmit={handle} className="space-y-4">
                            <input type="email" required placeholder={TEXT.emailLabel} className="w-full p-3 border border-slate-300 rounded-lg" value={email} onChange={e=>setEmail(e.target.value)} />
                            <input type="password" required placeholder={TEXT.passLabel} className="w-full p-3 border border-slate-300 rounded-lg" value={pass} onChange={e=>setPass(e.target.value)} />
                            {err && <div className="text-red-500 text-sm">{err}</div>}
                            <button disabled={busy} className="w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 transition">
                                {busy ? '...' : isReg ? TEXT.btnRegister : TEXT.btnLogin}
                            </button>
                        </form>
                        <div className="mt-6 text-center">
                            <button onClick={()=>setIsReg(!isReg)} className="text-sm text-blue-600 font-medium hover:underline">
                                {isReg ? "Masz konto? Zaloguj" : "Nie masz konta? Rejestracja"}
                            </button>
                        </div>
                    </div>
                </div>
            )
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
