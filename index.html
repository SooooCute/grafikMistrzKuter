<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KUTER - System Grafik v8.3</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155',
                            600: '#475569',
                            text: '#f1f5f9'
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* --- STYLES FOR PRINT (A4 OPTIMIZED) --- */
        @media print {
            @page {
                size: A4 landscape;
                margin: 5mm;
            }
            body { 
                background: white !important; 
                color: black !important;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                zoom: 0.60; 
            }
            .no-print { display: none !important; }
            .print-show { display: block !important; }
            ::-webkit-scrollbar { display: none; }
            body, #root, main { height: auto !important; overflow: visible !important; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            th, td { border: 1px solid #333 !important; padding: 4px !important; page-break-inside: avoid; }
            h1 { font-size: 24px; color: black; margin-bottom: 10px; }
            .bg-indigo-50\/30, .bg-orange-50\/30, .bg-blue-50\/30 { background-color: transparent !important; }
            .rounded { border-radius: 0 !important; border: none !important; }
            .text-xs { font-size: 11px !important; }
            
            /* Dark mode overrides for print */
            .dark .bg-slate-900 { background-color: white !important; color: black !important; }
            .dark .text-slate-200 { color: black !important; }
            .dark .bg-slate-800 { background-color: white !important; border: 1px solid #ccc; }
        }
        .print-show { display: none; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1e293b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200 transition-colors duration-300">
    <div id="root"></div>

    <!-- Error Handler -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const errDiv = document.createElement('div');
            errDiv.style.cssText = 'color:red; background:white; padding:20px; border:2px solid red; margin:20px; z-index:9999; position:relative; font-weight:bold;';
            errDiv.innerHTML = '<h3>CRITICAL ERROR:</h3><p>' + message + '</p><p>Line: ' + lineno + '</p>';
            document.body.prepend(errDiv);
        };
        console.log("--- KUTER SYSTEM v8.3 LOADED ---");
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDPIZCV4h6Crh254OtZExUaLQtAgjWS1iM",
            authDomain: "grafikmistrz.firebaseapp.com",
            projectId: "grafikmistrz",
            storageBucket: "grafikmistrz.firebasestorage.app",
            messagingSenderId: "605834476831",
            appId: "1:605834476831:web:8da87595b0acb2beb7c42a"
        };

        let app, auth, db;
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            auth = firebase.auth();
            db = firebase.firestore();
            console.log("Firebase Initialized");
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        // --- TEXTS ---
        const TEXT = {
            appName: "KUTER",
            appSub: "Sma≈ºalnia & Grill",
            tabStaff: "Zesp√≥≈Ç",
            tabCalendar: "Grafik",
            tabStats: "Raporty",
            tabReservations: "Rezerwacje",
            secWaiters: "Obs≈Çuga (Kelnerzy)",
            secBartenders: "Barmani",
            addBtn: "Dodaj pracownika",
            namePlaceholder: "Imiƒô i nazwisko...",
            genBtn: "Generuj Grafik",
            optimizeBtn: "‚öñÔ∏è Optymalizacja",
            exportGoogle: "üìã Kopiuj",
            printBtn: "üñ®Ô∏è Drukuj",
            dateCol: "Data",
            barCol: "Bar",
            morningCol: "Rano (10:00)",
            eveningCol: "Popo≈Çudnie (12:00)",
            loginTitle: "Panel Pracowniczy",
            btnLogin: "Zaloguj",
            btnRegister: "Rejestracja",
            btnLogout: "Wyloguj",
            emailLabel: "Email",
            passLabel: "Has≈Ço",
            archive: "Archiwizuj",
            genSettings: "Konfiguracja Zmian",
            totalStaff: "Obs≈Çuga ≈ÇƒÖcznie:",
            morningStaff: "W tym rano:",
            cancel: "Anuluj",
            generate: "Start",
            deleteConfirm: "Czy zarchiwizowaƒá pracownika?",
            deleteSub: "Zniknie z listy aktywnej, ale zostanie w historii.",
            errorAuth: "B≈ÇƒÖd logowania. Sprawd≈∫ dane.",
            copySuccess: "Skopiowano! Wklej (Ctrl+V) w Google Sheets.",
            optimizing: "Optymalizacja...",
            resAdd: "Dodaj",
            resName: "Nazwisko",
            resTime: "Godz",
            resPax: "Os√≥b",
            resTables: "Stoliki",
            resDeposit: "Zadatek",
            resDate: "Data",
            resNoData: "Brak rezerwacji na ten dzie≈Ñ.",
            resTotalDeposit: "Suma zadatk√≥w:",
            resStatus: "Status"
        };

        // --- CLOCK ---
        function LiveClock() {
            const [time, setTime] = useState(new Date());
            useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            return (
                <div className="flex flex-col items-end">
                    <div className="text-2xl md:text-3xl font-bold text-amber-400 leading-none drop-shadow-md" style={{fontFamily: 'monospace'}}>
                        {time.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                    <div className="text-[10px] md:text-xs font-bold text-slate-300 uppercase tracking-wider mt-1">
                        {time.toLocaleDateString('pl-PL', { weekday: 'long', day: 'numeric', month: 'long' })}
                    </div>
                </div>
            );
        }

        // --- APP COMPONENT ---
        function App() {
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [people, setPeople] = useState([]);
            const [schedule, setSchedule] = useState({});
            const [holidays, setHolidays] = useState([]);
            const [reservations, setReservations] = useState({});
            
            const [activeTab, setActiveTab] = useState('staff');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [loading, setLoading] = useState(true);
            const [darkMode, setDarkMode] = useState(localStorage.getItem('theme') === 'dark');
            
            const [newName, setNewName] = useState('');
            const [newGender, setNewGender] = useState('male');
            const [newRole, setNewRole] = useState('waiter');
            
            const [addingToSlot, setAddingToSlot] = useState(null);
            const [personToRemove, setPersonToRemove] = useState(null);
            const [genSettings, setGenSettings] = useState(null);
            const [isOptimizing, setIsOptimizing] = useState(false);

            const [resForm, setResForm] = useState(null);
            const [newResData, setNewResData] = useState({ name: '', time: '12:00', pax: 2, tables: '', deposit: 0, status: 'pending' });

            // Dark Mode Effect
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            }, [darkMode]);

            // Auth
            useEffect(() => {
                const unsub = auth.onAuthStateChanged(u => {
                    setUser(u);
                    setIsAuthReady(true);
                    if(!u) { setPeople([]); setSchedule({}); setReservations({}); }
                });
                return () => unsub();
            }, []);

            // Data
            useEffect(() => {
                if(!user || !db) return;
                setLoading(true);
                const ref = `artifacts/${firebaseConfig.projectId}/users/${user.uid}`;
                
                const unsubPeople = db.collection(`${ref}/people`).onSnapshot(snap => {
                    setPeople(snap.docs.map(d => ({id: d.id, ...d.data()})));
                });
                const unsubSched = db.doc(`${ref}/appData/schedule`).onSnapshot(snap => {
                    setSchedule(snap.data() || {});
                });
                const unsubHol = db.doc(`${ref}/appData/holidays`).onSnapshot(snap => {
                    setHolidays(snap.data()?.dates || []);
                });
                const unsubRes = db.doc(`${ref}/appData/reservations`).onSnapshot(snap => {
                    setReservations(snap.data() || {});
                    setLoading(false);
                });

                return () => { unsubPeople(); unsubSched(); unsubHol(); unsubRes(); };
            }, [user]);

            const getPerson = (id) => people.find(p => p.id === id);
            const getUserRef = () => `artifacts/${firebaseConfig.projectId}/users/${user.uid}`;
            const getMonthName = (d) => d.toLocaleString('pl-PL', { month: 'long', year: 'numeric' });
            
            const changeMonth = (d) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(newDate.getMonth() + d);
                setCurrentDate(newDate);
            };

            const getBarmanArray = (shift) => {
                if (!shift || !shift.barman) return [];
                if (Array.isArray(shift.barman)) return shift.barman;
                return [shift.barman];
            };

            const stats = useMemo(() => {
                const s = {};
                people.forEach(p => s[p.id] = { h: 0, covers: 0 });
                const daysInM = new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate();
                
                for(let i=1; i<=daysInM; i++) {
                    const dObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                    const dStr = dObj.toLocaleDateString('en-CA');
                    const dayOfWeek = dObj.getDay();
                    const shift = schedule[dStr];
                    
                    if(shift) {
                        const barmen = getBarmanArray(shift);
                        barmen.forEach((bid, index) => {
                            if(s[bid]) {
                                let hours = 12;
                                if (dayOfWeek === 5 && index > 0) hours = 7; 
                                else if (dayOfWeek === 0 && index > 0) hours = 6; 
                                s[bid].h += hours;
                                if(getPerson(bid)?.role === 'waiter') s[bid].covers++;
                            }
                        });
                        shift.morning.forEach(id => { if(s[id]) s[id].h += 10; });
                        shift.evening.forEach(id => { if(s[id]) s[id].h += 12; });
                    }
                }
                return s;
            }, [people, schedule, currentDate]);

            const getStreak = (pid, dateStr) => {
                const d = new Date(dateStr);
                let streak = 0;
                for(let i=1; i<=5; i++) {
                    const prev = new Date(d);
                    prev.setDate(d.getDate() - i);
                    const pStr = prev.toLocaleDateString('en-CA');
                    const s = schedule[pStr];
                    if(s) {
                        const barmen = getBarmanArray(s);
                        if (barmen.includes(pid) || s.morning.includes(pid) || s.evening.includes(pid)) streak++;
                        else break;
                    } else break;
                }
                return streak;
            };

            // --- ACTIONS ---
            const addPerson = async () => {
                if(!newName.trim()) return;
                await db.collection(`${getUserRef()}/people`).add({
                    name: newName.trim(),
                    gender: newGender,
                    role: newRole,
                    daysOff: [],
                    archived: false
                });
                setNewName('');
            };

            const archivePerson = async () => {
                if(personToRemove) {
                    await db.doc(`${getUserRef()}/people/${personToRemove}`).update({ archived: true });
                    setPersonToRemove(null);
                }
            };

            const toggleDayOff = async (pid, day) => {
                const p = getPerson(pid);
                if(!p) return;
                const dateStr = new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toLocaleDateString('en-CA');
                const newOff = p.daysOff.includes(dateStr) ? p.daysOff.filter(d => d !== dateStr) : [...p.daysOff, dateStr];
                await db.doc(`${getUserRef()}/people/${pid}`).update({ daysOff: newOff });
            };

            const toggleHoliday = async (dateStr) => {
                const newHols = holidays.includes(dateStr) ? holidays.filter(d => d !== dateStr) : [...holidays, dateStr];
                await db.doc(`${getUserRef()}/appData/holidays`).set({ dates: newHols });
            };

            const removeFromShift = async (dateStr, type, personId) => {
                const shift = schedule[dateStr];
                if (!shift) return;
                let newShift = { ...shift };
                if (type === 'bar') {
                    const barmen = getBarmanArray(shift);
                    newShift.barman = barmen.filter(id => id !== personId);
                } else {
                    newShift[type] = shift[type].filter(id => id !== personId);
                }
                await db.doc(`${getUserRef()}/appData/schedule`).update({ [dateStr]: newShift });
            };

            const addToShift = async (dateStr, type, personId) => {
                const shift = schedule[dateStr] || { date: dateStr, morning: [], evening: [], barman: [] };
                let newShift = { ...shift };
                if (type === 'bar') {
                    const prev = getBarmanArray(shift);
                    newShift.barman = [...prev, personId];
                } else {
                    newShift[type] = [...(shift[type] || []), personId];
                }
                await db.doc(`${getUserRef()}/appData/schedule`).set({ [dateStr]: newShift }, { merge: true });
                setAddingToSlot(null);
            };

            // RESERVATION
            const addReservation = async () => {
                if (!newResData.name || !resForm.date) return;
                const dateStr = resForm.date.toLocaleDateString('en-CA');
                const currentResList = reservations[dateStr] || [];
                const newRes = { id: Date.now().toString(), ...newResData, status: 'pending' };
                await db.doc(`${getUserRef()}/appData/reservations`).set({ ...reservations, [dateStr]: [...currentResList, newRes] }, { merge: true });
                setResForm(null);
                setNewResData({ name: '', time: '12:00', pax: 2, tables: '', deposit: 0, status: 'pending' });
            };

            const removeReservation = async (dateStr, resId) => {
                const currentResList = reservations[dateStr] || [];
                const updatedList = currentResList.filter(r => r.id !== resId);
                await db.doc(`${getUserRef()}/appData/reservations`).update({ [dateStr]: updatedList });
            };

            const toggleResStatus = async (dateStr, resId) => {
                const currentResList = reservations[dateStr] || [];
                const updatedList = currentResList.map(r => {
                    if (r.id === resId) {
                        const nextStatus = r.status === 'pending' ? 'done' : r.status === 'done' ? 'cancelled' : 'pending';
                        return { ...r, status: nextStatus };
                    }
                    return r;
                });
                await db.doc(`${getUserRef()}/appData/reservations`).update({ [dateStr]: updatedList });
            };

            const copyToGoogleSheets = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let tsvContent = "Data\tDzie≈Ñ\t≈öwiƒôto\tBar\tRano\tPopo≈Çudnie\n";
                for (let day = 1; day <= daysInMonth; day++) {
                    const d = new Date(year, month, day);
                    const dateDisplay = d.toLocaleDateString('pl-PL');
                    const dayName = d.toLocaleDateString('pl-PL', { weekday: 'long' });
                    const isHol = holidays.includes(d.toLocaleDateString('en-CA')) ? "TAK" : "";
                    const s = schedule[d.toLocaleDateString('en-CA')] || { morning: [], evening: [], barman: [] };
                    const barmen = getBarmanArray(s);
                    const barNames = barmen.map(id => getPerson(id)?.name || "").join(", ");
                    const mornNames = s.morning.map(id => getPerson(id)?.name || "").join(", ");
                    const eveNames = s.evening.map(id => getPerson(id)?.name || "").join(", ");
                    tsvContent += `${dateDisplay}\t${dayName}\t${isHol}\t${barNames}\t${mornNames}\t${eveNames}\n`;
                }
                navigator.clipboard.writeText(tsvContent).then(() => { alert(TEXT.copySuccess); }, (err) => { console.error('Async: Could not copy text: ', err); });
            };

            // --- GENERATOR (SAFE) ---
            const generateScheduleData = (peopleList, year, month, totalNeeded, morningNeeded) => {
                try {
                    const daysCount = new Date(year, month + 1, 0).getDate();
                    let pool = peopleList.filter(p => !p.archived).map(p => ({ ...p, hours: 0, streak: 0, barCount: 0 }));
                    const newSched = {};

                    const getScore = (p, role) => {
                        let s = p.hours;
                        if(p.streak >= 4) s += 1000; 
                        if(role === 'bartender' && p.role === 'waiter') s += (p.barCount * 50);
                        return s + Math.random() * 10;
                    };

                    for(let day = 1; day <= daysCount; day++) {
                        const dateObj = new Date(year, month, day);
                        const dateStr = dateObj.toLocaleDateString('en-CA');
                        const dayOfWeek = dateObj.getDay();
                        const available = pool.filter(p => !p.daysOff.includes(dateStr));
                        
                        // BAR
                        let selectedBarmen = [];
                        let realBarmans = available.filter(p => p.role === 'bartender').sort((a,b) => getScore(a,'bartender') - getScore(b,'bartender'));
                        const isWeekendHigh = (dayOfWeek === 5 || dayOfWeek === 6 || dayOfWeek === 0);
                        const neededBarmen = isWeekendHigh ? 2 : 1;

                        let safety = 0;
                        while (selectedBarmen.length < neededBarmen && realBarmans.length > 0 && safety < 50) { selectedBarmen.push(realBarmans.shift()); safety++; }
                        
                        if (selectedBarmen.length < neededBarmen) {
                            let waiterBarmans = available.filter(p => p.role === 'waiter' && !selectedBarmen.includes(p)).sort((a,b) => getScore(a,'bartender') - getScore(b,'bartender'));
                            safety = 0;
                            while (selectedBarmen.length < neededBarmen && waiterBarmans.length > 0 && safety < 50) {
                                const w = waiterBarmans.shift();
                                selectedBarmen.push(w);
                                pool.find(p => p.id === w.id).barCount++;
                                safety++;
                            }
                        }
                        selectedBarmen.forEach((bm, idx) => {
                            const p = pool.find(x => x.id === bm.id);
                            let hours = 12; 
                            if (dayOfWeek === 5 && idx > 0) hours = 7; 
                            else if (dayOfWeek === 0 && idx > 0) hours = 6; 
                            p.hours += hours;
                            p.streak++;
                        });
                        const barmanIds = selectedBarmen.map(b => b.id);

                        // WAITERS
                        let waiterCands = available.filter(p => p.role === 'waiter' && !barmanIds.includes(p.id));
                        const barHasMale = selectedBarmen.some(b => b.gender === 'male');
                        let selectedWaiters = [];
                        if(!barHasMale) {
                            const males = waiterCands.filter(w => w.gender === 'male').sort((a,b) => getScore(a,'waiter') - getScore(b,'waiter'));
                            if(males.length > 0 && males[0].streak < 5) {
                                selectedWaiters.push(males[0]);
                                waiterCands = waiterCands.filter(x => x.id !== males[0].id);
                            }
                        }
                        waiterCands.sort((a,b) => getScore(a,'waiter') - getScore(b,'waiter'));
                        safety = 0;
                        while(selectedWaiters.length < totalNeeded && waiterCands.length > 0 && safety < 50) {
                            selectedWaiters.push(waiterCands.shift());
                            safety++;
                        }

                        selectedWaiters.forEach(w => {
                            const p = pool.find(x => x.id === w.id);
                            p.hours += 10.5;
                            p.streak++;
                        });

                        const workedIds = [...barmanIds, ...selectedWaiters.map(w=>w.id)];
                        pool.forEach(p => { if(!workedIds.includes(p.id)) p.streak = 0; });

                        selectedWaiters.sort((a,b) => a.hours - b.hours);
                        const morningCrew = selectedWaiters.slice(0, morningNeeded).map(w => w.id);
                        const eveningCrew = selectedWaiters.slice(morningNeeded).map(w => w.id);

                        newSched[dateStr] = { barman: barmanIds, morning: morningCrew, evening: eveningCrew };
                    }
                    
                    const hours = pool.map(p => p.hours);
                    const max = Math.max(...hours);
                    const min = Math.min(...hours);
                    const diff = max - min;
                    return { schedule: newSched, diff: diff, pool: pool };
                } catch (err) {
                    console.error("Generator logic error", err);
                    return { schedule: {}, diff: 99999, pool: [] };
                }
            };

            const openGenSettings = () => {
                const month = currentDate.getMonth();
                const isHighSeason = month >= 4 && month <= 8;
                setGenSettings({
                    show: true,
                    total: isHighSeason ? 6 : 4,
                    morning: isHighSeason ? 3 : 2,
                    optimize: false
                });
            };

            const runGenerator = async (shouldOptimize) => {
                if(!genSettings) return;
                const { total, morning } = genSettings;
                
                if (shouldOptimize) {
                    setIsOptimizing(true);
                    setTimeout(async () => {
                        try {
                            let bestResult = null;
                            for(let i=0; i<50; i++) {
                                const result = generateScheduleData(people, currentDate.getFullYear(), currentDate.getMonth(), total, morning);
                                if (!bestResult || result.diff < bestResult.diff) {
                                    bestResult = result;
                                }
                            }
                            if(bestResult && bestResult.schedule) {
                                await db.doc(`${getUserRef()}/appData/schedule`).set(bestResult.schedule, {merge: true});
                            }
                        } catch (e) {
                            console.error("Optimization failed", e);
                        } finally {
                            setIsOptimizing(false);
                            setGenSettings(null);
                            setActiveTab('calendar');
                        }
                    }, 100);
                } else {
                    const result = generateScheduleData(people, currentDate.getFullYear(), currentDate.getMonth(), total, morning);
                    await db.doc(`${getUserRef()}/appData/schedule`).set(result.schedule, {merge: true});
                    setGenSettings(null);
                    setActiveTab('calendar');
                }
            };

            if(!isAuthReady) return <div className="flex h-screen items-center justify-center dark:bg-slate-900"><div className="loader"></div></div>;
            if(!user) return <AuthScreen />;
            
            return (
                <div className="min-h-screen flex flex-col dark:bg-slate-900 dark:text-slate-200 transition-colors">
                    {/* HEADER */}
                    <nav className="bg-slate-900 text-white shadow-lg no-print">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex flex-col md:flex-row justify-between items-center h-auto md:h-20 py-4 md:py-0 gap-4">
                                <div className="flex items-center gap-4 w-full md:w-auto justify-center md:justify-start">
                                    <div className="h-10 w-10 md:h-12 md:w-12 bg-slate-800 rounded-full flex items-center justify-center overflow-hidden border-2 border-slate-600 shrink-0">
                                        <img src="logo.jpg" alt="Kuter" className="h-full w-full object-cover" onError={(e)=>{e.target.style.display='none'}} />
                                        <span className="text-xs font-bold text-slate-400 absolute" style={{zIndex:-1}}>K</span>
                                    </div>
                                    <div className="text-center md:text-left">
                                        <h1 className="text-lg md:text-xl font-bold tracking-wide text-white">{TEXT.appName}</h1>
                                        <p className="text-[10px] md:text-xs text-slate-400 tracking-widest uppercase">{TEXT.appSub}</p>
                                    </div>
                                </div>

                                <div className="flex items-center gap-4 w-full md:w-auto justify-center">
                                    <div className="hidden md:block text-right border-r border-slate-700 pr-6 mr-2">
                                        <LiveClock />
                                    </div>
                                    <div className="flex items-center gap-2 bg-slate-800 rounded-lg p-1">
                                        <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-slate-700 rounded text-slate-300 transition">‚óÄ</button>
                                        <span className="px-2 md:px-4 font-medium min-w-[100px] md:min-w-[140px] text-center capitalize text-sm md:text-base">{getMonthName(currentDate)}</span>
                                        <button onClick={() => changeMonth(1)} className="p-2 hover:bg-slate-700 rounded text-slate-300 transition">‚ñ∂</button>
                                    </div>
                                    <button onClick={()=>setDarkMode(!darkMode)} className="p-2 text-xl hover:text-yellow-400 transition" title="Dark Mode">
                                        {darkMode ? '‚òÄÔ∏è' : 'üåô'}
                                    </button>
                                    <button onClick={()=>auth.signOut()} className="text-slate-400 hover:text-white transition text-xs md:text-sm font-medium px-2">{TEXT.btnLogout}</button>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white border-b border-slate-200 text-slate-600 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300 overflow-x-auto">
                            <div className="max-w-7xl mx-auto px-4 flex gap-2 md:gap-8 min-w-max">
                                {['staff', 'calendar', 'reservations', 'stats'].map(tab => (
                                    <button key={tab} onClick={() => setActiveTab(tab)}
                                        className={`py-3 md:py-4 px-2 md:px-0 font-medium border-b-2 transition text-sm md:text-base ${activeTab === tab ? 'border-blue-900 text-blue-900 dark:text-blue-400 dark:border-blue-400' : 'border-transparent hover:text-slate-900 dark:hover:text-white'}`}
                                    >
                                        {tab === 'staff' && `üë• ${TEXT.tabStaff}`}
                                        {tab === 'calendar' && `üìÖ ${TEXT.tabCalendar}`}
                                        {tab === 'stats' && `üìä ${TEXT.tabStats}`}
                                        {tab === 'reservations' && `üçΩÔ∏è ${TEXT.tabReservations}`}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    <main className="flex-grow bg-slate-50 p-2 md:p-8 max-w-7xl mx-auto w-full dark:bg-slate-900">
                        <div className="hidden print-show mb-4 border-b pb-2">
                            <h1 className="text-2xl font-bold">{TEXT.appName} - {activeTab === 'reservations' ? TEXT.tabReservations : 'Grafik'}: {getMonthName(currentDate)}</h1>
                        </div>

                        {activeTab === 'staff' && (
                            <div className="space-y-6 md:space-y-8">
                                <div className="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700 no-print">
                                    <h2 className="text-lg font-bold text-slate-800 dark:text-slate-100 mb-4 flex items-center gap-2"><span className="bg-blue-100 text-blue-800 p-1 rounded dark:bg-blue-900 dark:text-blue-200">‚ûï</span> {TEXT.addBtn}</h2>
                                    <div className="flex flex-col md:flex-row gap-3">
                                        <input value={newName} onChange={e=>setNewName(e.target.value)} placeholder={TEXT.namePlaceholder} className="flex-grow border border-slate-300 p-2.5 rounded-lg outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white" />
                                        <div className="flex gap-2">
                                            <select value={newGender} onChange={e=>setNewGender(e.target.value)} className="border border-slate-300 p-2.5 rounded-lg bg-white flex-1 dark:bg-slate-700 dark:border-slate-600 dark:text-white"><option value="male">Ch≈Çopak</option><option value="female">Dziewczyna</option></select>
                                            <select value={newRole} onChange={e=>setNewRole(e.target.value)} className="border border-slate-300 p-2.5 rounded-lg bg-white flex-1 dark:bg-slate-700 dark:border-slate-600 dark:text-white"><option value="waiter">Kelner</option><option value="bartender">Barman</option></select>
                                        </div>
                                        <button onClick={addPerson} className="bg-blue-900 text-white px-6 py-2.5 rounded-lg font-medium hover:bg-blue-800 transition dark:bg-blue-700">Dodaj</button>
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {[TEXT.secWaiters, TEXT.secBartenders].map((title, idx) => {
                                        const role = idx === 0 ? 'waiter' : 'bartender';
                                        const list = people.filter(p => p.role === role && !p.archived);
                                        return (
                                            <div key={role} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden dark:bg-slate-800 dark:border-slate-700">
                                                <div className="bg-slate-50 px-4 md:px-6 py-4 border-b border-slate-200 font-semibold text-slate-700 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300">{title}</div>
                                                <div className="p-4 md:p-6 space-y-4">
                                                    {list.map(p => (
                                                        <div key={p.id} className="bg-white border border-slate-100 rounded-lg p-3 hover:border-blue-200 transition group dark:bg-slate-700 dark:border-slate-600">
                                                            <div className="flex justify-between items-center mb-3">
                                                                <div className="font-bold text-slate-800 dark:text-white">{p.gender === 'male' ? 'üë®' : 'üë©'} {p.name}</div>
                                                                <button onClick={()=>setPersonToRemove(p.id)} className="text-slate-300 hover:text-red-500 transition no-print p-2">üóëÔ∏è</button>
                                                            </div>
                                                            <div className="flex flex-wrap gap-1 no-print">
                                                                {Array.from({ length: new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate() }, (_, i) => i + 1).map(day => {
                                                                    const dStr = new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toLocaleDateString('en-CA');
                                                                    const isOff = p.daysOff.includes(dStr);
                                                                    return (
                                                                        <button key={day} onClick={() => toggleDayOff(p.id, day)} 
                                                                            className={`w-8 h-8 md:w-7 md:h-7 text-xs rounded font-medium transition ${isOff ? 'bg-red-500 text-white' : 'bg-slate-100 text-slate-600 dark:bg-slate-600 dark:text-slate-300'}`}>
                                                                            {day}
                                                                        </button>
                                                                    )
                                                                })}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                                <div className="fixed bottom-6 right-6 no-print z-30">
                                    <button onClick={openGenSettings} className="bg-indigo-600 text-white px-6 py-4 rounded-full shadow-xl font-bold shadow-indigo-900/20 flex items-center gap-2 hover:scale-105 transition dark:bg-indigo-500">‚öôÔ∏è {TEXT.genBtn}</button>
                                </div>
                            </div>
                        )}

                        {activeTab === 'calendar' && (
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden dark:bg-slate-800 dark:border-slate-700">
                                <div className="p-4 border-b border-slate-200 flex flex-col md:flex-row justify-between items-center bg-slate-50 no-print gap-3 dark:bg-slate-800 dark:border-slate-700">
                                    <div className="text-sm text-slate-500 dark:text-slate-400">‚ÑπÔ∏è Kliknij <span className="font-bold text-yellow-600">‚òÖ</span> aby oznaczyƒá ≈õwiƒôto.</div>
                                    <div className="flex gap-2 w-full md:w-auto">
                                        <button onClick={copyToGoogleSheets} className="flex-1 md:flex-none bg-white border border-slate-300 px-3 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-emerald-50 text-emerald-700 border-emerald-200 text-center dark:bg-slate-700 dark:border-slate-600 dark:text-emerald-400">
                                            {TEXT.exportGoogle}
                                        </button>
                                        <button onClick={()=>window.print()} className="flex-1 md:flex-none bg-white border border-slate-300 px-3 py-2 rounded-lg text-xs md:text-sm font-medium hover:bg-slate-50 text-slate-700 text-center dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300">{TEXT.printBtn}</button>
                                    </div>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left border-collapse min-w-[600px]">
                                        <thead>
                                            <tr className="bg-slate-100 text-xs uppercase text-slate-500 tracking-wider dark:bg-slate-900 dark:text-slate-400">
                                                <th className="p-2 md:p-4 font-bold border-b border-slate-200 w-16 dark:border-slate-700">{TEXT.dateCol}</th>
                                                <th className="p-2 md:p-4 font-bold border-b border-slate-200 w-1/4 bg-indigo-50/50 text-indigo-900 dark:bg-indigo-900/20 dark:text-indigo-300 dark:border-slate-700">{TEXT.barCol}</th>
                                                <th className="p-2 md:p-4 font-bold border-b border-slate-200 w-1/3 bg-orange-50/50 text-orange-900 dark:bg-orange-900/20 dark:text-orange-300 dark:border-slate-700">{TEXT.morningCol}</th>
                                                <th className="p-2 md:p-4 font-bold border-b border-slate-200 w-1/3 bg-blue-50/50 text-blue-900 dark:bg-blue-900/20 dark:text-blue-300 dark:border-slate-700">{TEXT.eveningCol}</th>
                                            </tr>
                                        </thead>
                                        <tbody className="text-sm text-slate-700 divide-y divide-slate-100 dark:text-slate-300 dark:divide-slate-700">
                                            {Array.from({ length: new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate() }, (_, i) => i + 1).map(day => {
                                                const dateObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                                                const dateStr = dateObj.toLocaleDateString('en-CA');
                                                const isHol = holidays.includes(dateStr);
                                                const isWknd = dateObj.getDay() % 6 === 0;
                                                const s = schedule[dateStr] || { barman: [], morning: [], evening: [] };
                                                const rowClass = isHol ? 'bg-red-50 dark:bg-red-900/20' : isWknd ? 'bg-slate-50 dark:bg-slate-800/50' : '';

                                                const PersonBadge = ({uid, type, onDelete}) => {
                                                    const p = getPerson(uid);
                                                    if(!p) return null;
                                                    const streak = getStreak(uid, dateStr);
                                                    const isBurnout = streak >= 4;
                                                    const isCover = type === 'bar' && p.role === 'waiter';
                                                    let bgClass = '';
                                                    if (type === 'bar') bgClass = isCover ? 'bg-yellow-100 text-yellow-900 border-yellow-300 dark:bg-yellow-900/40 dark:text-yellow-200 dark:border-yellow-700' : 'bg-indigo-100 text-indigo-800 border-indigo-200 dark:bg-indigo-900/40 dark:text-indigo-200 dark:border-indigo-700';
                                                    else if (type === 'morn') bgClass = 'bg-orange-100 text-orange-800 border-orange-200 dark:bg-orange-900/40 dark:text-orange-200 dark:border-orange-700';
                                                    else bgClass = 'bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900/40 dark:text-blue-200 dark:border-blue-700';

                                                    return (
                                                        <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[10px] md:text-xs font-medium border mr-1 mb-1 ${bgClass}`}>
                                                            {p.name} {isCover && '‚ö†Ô∏è'} {isBurnout && 'üî•'}
                                                            <button onClick={onDelete} className="ml-1 text-slate-400 hover:text-red-600 no-print font-bold px-1">√ó</button>
                                                        </span>
                                                    )
                                                };

                                                return (
                                                    <tr key={day} className={rowClass}>
                                                        <td className="p-2 md:p-3 align-top border-r border-slate-100 relative group dark:border-slate-700">
                                                            <div className="font-bold text-base md:text-lg leading-none">{day}</div>
                                                            <div className="text-[10px] md:text-xs text-slate-400 uppercase mt-1">{dateObj.toLocaleDateString('pl-PL', {weekday:'short'})}</div>
                                                            <button onClick={()=>toggleHoliday(dateStr)} className={`absolute top-2 right-1 text-base no-print opacity-50 hover:opacity-100`}>‚òÖ</button>
                                                        </td>
                                                        {['bar', 'morning', 'evening'].map(role => {
                                                            const isBar = role === 'bar';
                                                            const userIds = isBar ? getBarmanArray(s) : (role === 'morning' ? s.morning : s.evening);
                                                            const bgColor = isBar ? 'bg-indigo-50/30 dark:bg-indigo-900/10' : role==='morning' ? 'bg-orange-50/30 dark:bg-orange-900/10' : 'bg-blue-50/30 dark:bg-blue-900/10';
                                                            
                                                            return (
                                                                <td key={role} className={`p-1 md:p-2 align-top ${bgColor} border-r border-slate-100 relative dark:border-slate-700`}>
                                                                    <div className="min-h-[40px] flex flex-wrap content-start">
                                                                        {userIds.map(uid => (
                                                                            <PersonBadge key={uid} uid={uid} type={isBar ? 'bar' : role==='morning' ? 'morn' : 'eve'} 
                                                                                onDelete={()=>{
                                                                                    const ns = {...s};
                                                                                    if(isBar) {
                                                                                        const prev = getBarmanArray(s);
                                                                                        ns.barman = prev.filter(x=>x!==uid);
                                                                                    } else ns[role] = ns[role].filter(x=>x!==uid);
                                                                                    db.doc(`${getUserRef()}/appData/schedule`).update({[dateStr]: ns});
                                                                                }} 
                                                                            />
                                                                        ))}
                                                                        <button className="absolute bottom-0 right-0 p-2 text-slate-300 hover:text-blue-600 no-print text-lg leading-none dark:hover:text-blue-400"
                                                                            onClick={()=>setAddingToSlot({date: dateStr, type: isBar ? 'bar' : role})}>
                                                                            ‚ûï
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            )
                                                        })}
                                                    </tr>
                                                )
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'reservations' && (
                            <div className="space-y-6">
                                <div className="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200 no-print dark:bg-slate-800 dark:border-slate-700">
                                    <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2 dark:text-slate-100">
                                        <span className="bg-amber-100 text-amber-800 p-1 rounded dark:bg-amber-900 dark:text-amber-200">üìÖ</span> {TEXT.tabReservations}
                                    </h2>
                                    <div className="flex overflow-x-auto pb-4 gap-2">
                                        {Array.from({ length: new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate() }, (_, i) => i + 1).map(day => {
                                            const dObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                                            const dStr = dObj.toLocaleDateString('en-CA');
                                            const hasRes = (reservations[dStr] && reservations[dStr].length > 0);
                                            const isSel = resForm?.date && resForm.date.getDate() === day;
                                            return (
                                                <button key={day} 
                                                    onClick={() => setResForm({ date: dObj })}
                                                    className={`flex-shrink-0 w-12 h-12 md:w-14 md:h-14 rounded-lg border flex flex-col items-center justify-center transition
                                                        ${isSel ? 'bg-amber-100 border-amber-400 text-amber-900 dark:bg-amber-900 dark:border-amber-500 dark:text-amber-100' : hasRes ? 'bg-amber-50 border-amber-200 dark:bg-slate-700 dark:border-amber-800' : 'bg-white border-slate-200 hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-600 dark:hover:bg-slate-700'}
                                                    `}
                                                >
                                                    <span className="text-base md:text-lg font-bold dark:text-slate-200">{day}</span>
                                                    {hasRes && <span className="w-1.5 h-1.5 bg-amber-500 rounded-full"></span>}
                                                </button>
                                            )
                                        })}
                                    </div>
                                </div>

                                {resForm?.date && (
                                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden dark:bg-slate-800 dark:border-slate-700">
                                        <div className="bg-amber-50 px-4 md:px-6 py-4 border-b border-amber-200 flex flex-col md:flex-row justify-between md:items-center gap-2 dark:bg-amber-900/20 dark:border-amber-900">
                                            <span className="font-bold text-amber-900 text-lg dark:text-amber-200">
                                                {resForm.date.toLocaleDateString('pl-PL', { weekday: 'long', day: 'numeric', month: 'long' })}
                                            </span>
                                            <span className="text-amber-700 font-medium text-sm dark:text-amber-300">
                                                {TEXT.resTotalDeposit}: {(reservations[resForm.date.toLocaleDateString('en-CA')] || []).reduce((acc, r) => acc + parseFloat(r.deposit || 0), 0)} PLN
                                            </span>
                                        </div>
                                        
                                        {/* ADD FORM */}
                                        <div className="p-4 bg-white border-b border-slate-100 no-print dark:bg-slate-800 dark:border-slate-700">
                                            <div className="grid grid-cols-2 md:flex md:flex-wrap gap-3 items-end">
                                                <div className="col-span-2 md:flex-grow">
                                                    <label className="text-[10px] text-slate-500 font-bold uppercase dark:text-slate-400">{TEXT.resName}</label>
                                                    <input className="w-full border p-2 rounded text-sm dark:bg-slate-700 dark:border-slate-600" value={newResData.name} onChange={e => setNewResData({...newResData, name: e.target.value})} />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] text-slate-500 font-bold uppercase dark:text-slate-400">{TEXT.resTime}</label>
                                                    <input type="time" className="w-full border p-2 rounded text-sm dark:bg-slate-700 dark:border-slate-600" value={newResData.time} onChange={e => setNewResData({...newResData, time: e.target.value})} />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] text-slate-500 font-bold uppercase dark:text-slate-400">{TEXT.resPax}</label>
                                                    <input type="number" className="w-full border p-2 rounded text-sm dark:bg-slate-700 dark:border-slate-600" value={newResData.pax} onChange={e => setNewResData({...newResData, pax: e.target.value})} />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] text-slate-500 font-bold uppercase dark:text-slate-400">{TEXT.resTables}</label>
                                                    <input className="w-full border p-2 rounded text-sm dark:bg-slate-700 dark:border-slate-600" placeholder="nr" value={newResData.tables} onChange={e => setNewResData({...newResData, tables: e.target.value})} />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] text-slate-500 font-bold uppercase dark:text-slate-400">{TEXT.resDeposit}</label>
                                                    <input type="number" className="w-full border p-2 rounded text-sm dark:bg-slate-700 dark:border-slate-600" placeholder="0" value={newResData.deposit} onChange={e => setNewResData({...newResData, deposit: e.target.value})} />
                                                </div>
                                                <button onClick={addReservation} className="col-span-2 md:col-span-1 bg-amber-600 text-white px-4 py-2 rounded font-bold hover:bg-amber-700 text-sm dark:bg-amber-700">{TEXT.resAdd}</button>
                                            </div>
                                        </div>

                                        {/* LIST */}
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-left min-w-[500px]">
                                                <thead className="bg-slate-50 text-slate-500 text-xs uppercase dark:bg-slate-900 dark:text-slate-400">
                                                    <tr>
                                                        <th className="p-3 md:p-4">{TEXT.resTime}</th>
                                                        <th className="p-3 md:p-4">{TEXT.resName}</th>
                                                        <th className="p-3 md:p-4">{TEXT.resPax}</th>
                                                        <th className="p-3 md:p-4">{TEXT.resTables}</th>
                                                        <th className="p-3 md:p-4">{TEXT.resDeposit}</th>
                                                        <th className="p-3 md:p-4">{TEXT.resStatus}</th>
                                                        <th className="p-3 md:p-4 w-10 no-print"></th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100 text-sm dark:divide-slate-700">
                                                    {(reservations[resForm.date.toLocaleDateString('en-CA')] || []).sort((a,b) => a.time.localeCompare(b.time)).map(r => (
                                                        <tr key={r.id} className={`hover:bg-slate-50 dark:hover:bg-slate-700 ${r.status === 'done' ? 'bg-green-50 dark:bg-green-900/20' : r.status === 'cancelled' ? 'bg-red-50 opacity-50 dark:bg-red-900/20' : ''}`}>
                                                            <td className="p-3 md:p-4 font-bold text-slate-700 dark:text-slate-200">{r.time}</td>
                                                            <td className="p-3 md:p-4 font-medium">{r.name}</td>
                                                            <td className="p-3 md:p-4">{r.pax} os.</td>
                                                            <td className="p-3 md:p-4">{r.tables || "-"}</td>
                                                            <td className="p-3 md:p-4 text-green-600 font-bold dark:text-green-400">{r.deposit > 0 ? `${r.deposit} PLN` : "-"}</td>
                                                            <td className="p-3 md:p-4 no-print">
                                                                <button onClick={() => toggleResStatus(resForm.date.toLocaleDateString('en-CA'), r.id)} 
                                                                    className={`text-xs font-bold px-2 py-1 rounded uppercase border ${
                                                                        r.status === 'done' ? 'border-green-500 text-green-600' : 
                                                                        r.status === 'cancelled' ? 'border-red-500 text-red-600' : 
                                                                        'border-slate-300 text-slate-400'
                                                                    }`}>
                                                                    {r.status === 'done' ? '‚úì OK' : r.status === 'cancelled' ? '‚úï CANCEL' : '? OCZEKUJE'}
                                                                </button>
                                                            </td>
                                                            <td className="p-3 md:p-4 no-print">
                                                                <button onClick={() => removeReservation(resForm.date.toLocaleDateString('en-CA'), r.id)} className="text-red-400 hover:text-red-600 text-lg">√ó</button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    {!(reservations[resForm.date.toLocaleDateString('en-CA')] || []).length && (
                                                        <tr><td colSpan="7" className="p-8 text-center text-slate-400 italic">Brak rezerwacji</td></tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'stats' && (
                            <div className="grid md:grid-cols-2 gap-6">
                                {[TEXT.secWaiters, TEXT.secBartenders].map((title, idx) => {
                                    const role = idx === 0 ? 'waiter' : 'bartender';
                                    const maxHours = Math.max(...Object.values(stats).map(s=>s.h), 1);
                                    const list = people.filter(p => p.role === role && (!p.archived || stats[p.id]?.h > 0))
                                        .sort((a,b) => stats[b.id].h - stats[a.id].h);
                                    
                                    return (
                                        <div key={role} className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden dark:bg-slate-800 dark:border-slate-700">
                                            <div className="bg-slate-50 px-6 py-3 border-b border-slate-200 font-bold text-slate-700 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300">{title}</div>
                                            <div className="p-6 space-y-4">
                                                {list.map(p => (
                                                    <div key={p.id}>
                                                        <div className="flex justify-between text-sm mb-1 font-medium text-slate-700 dark:text-slate-300">
                                                            <span className={p.archived ? 'text-slate-400 line-through' : ''}>{p.name}</span>
                                                            <span>{stats[p.id].h}h {role==='waiter' && stats[p.id].covers > 0 && <span className="text-yellow-600 font-bold text-xs ml-1 dark:text-yellow-400">({stats[p.id].covers} Bar)</span>}</span>
                                                        </div>
                                                        <div className="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden dark:bg-slate-700">
                                                            <div className={`h-2.5 rounded-full ${role==='waiter'?'bg-blue-500':'bg-indigo-500'} ${p.archived?'opacity-50':''}`} 
                                                                style={{width: `${(stats[p.id].h / maxHours) * 100}%`}}></div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        )}
                    </main>

                    {/* SMART ADDING MODAL */}
                    {addingToSlot && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={()=>setAddingToSlot(null)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh] dark:bg-slate-800" onClick={e=>e.stopPropagation()}>
                                <div className="p-4 bg-slate-50 border-b border-slate-100 font-bold text-slate-800 flex justify-between sticky top-0 bg-white z-10 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-200">
                                    <span>Dodaj: {addingToSlot.date}</span>
                                    <button onClick={()=>setAddingToSlot(null)} className="text-xl leading-none">&times;</button>
                                </div>
                                <div className="overflow-y-auto p-2 flex-grow">
                                    {people.filter(p => !p.archived).map(p => {
                                        // Filter logic
                                        const s = schedule[addingToSlot.date];
                                        const barmen = s ? getBarmanArray(s) : [];
                                        if(s && (barmen.includes(p.id) || s.morning.includes(p.id) || s.evening.includes(p.id))) return null;

                                        // --- NEW LOGIC: FILTER WAITERS FOR SHIFT ---
                                        // If adding to 'morning' or 'evening', show ONLY Waiters
                                        if((addingToSlot.type === 'morning' || addingToSlot.type === 'evening') && p.role !== 'waiter') return null;
                                        // If adding to 'bar', show EVERYONE (Waiters can cover Bar)
                                        
                                        const streak = getStreak(p.id, addingToSlot.date);
                                        const isBurnout = streak >= 4;
                                        const isDayOff = p.daysOff.includes(addingToSlot.date);
                                        const currentHours = stats[p.id]?.h || 0;
                                        let addedHours = 10;
                                        if (addingToSlot.type === 'bar' || addingToSlot.type === 'evening') addedHours = 12;
                                        return (
                                            <button key={p.id} disabled={isDayOff}
                                                onClick={()=>{
                                                    const ns = {...(schedule[addingToSlot.date] || {barman:[], morning:[], evening:[]})};
                                                    if(addingToSlot.type === 'bar') {
                                                        const prev = getBarmanArray(ns);
                                                        ns.barman = [...prev, p.id];
                                                    } else ns[addingToSlot.type] = [...ns[addingToSlot.type], p.id];
                                                    db.doc(`${getUserRef()}/appData/schedule`).set({[addingToSlot.date]: ns}, {merge:true});
                                                    setAddingToSlot(null);
                                                }} 
                                                className={`w-full text-left px-4 py-3 mb-2 rounded-lg border flex justify-between items-center transition ${isDayOff ? 'bg-red-50 border-red-100 opacity-60 cursor-not-allowed dark:bg-red-900/20 dark:border-red-800' : 'bg-white border-slate-100 hover:border-blue-300 hover:shadow-md dark:bg-slate-700 dark:border-slate-600'}`}>
                                                <div>
                                                    <div className="font-bold text-slate-800 flex items-center gap-2 dark:text-slate-200">
                                                        {p.name}
                                                        {isBurnout && <span title="Pracuje >4 dni z rzƒôdu!" className="text-lg">üî•</span>}
                                                        {p.role === 'waiter' && addingToSlot.type === 'bar' && <span className="text-xs bg-yellow-100 text-yellow-800 px-1.5 rounded dark:bg-yellow-900 dark:text-yellow-200">Zastƒôpstwo</span>}
                                                    </div>
                                                    <div className="text-xs text-slate-500 mt-0.5 dark:text-slate-400">Godziny: {currentHours}h <span className="text-blue-600 font-bold dark:text-blue-400">‚ûù ~{currentHours + addedHours}h</span></div>
                                                </div>
                                                {isDayOff ? <span className="text-xs bg-red-100 text-red-700 px-2 py-1 rounded font-bold uppercase dark:bg-red-900 dark:text-red-200">Urlop</span> : <span className="text-blue-600 font-bold text-xl dark:text-blue-400">+</span>}
                                            </button>
                                        )
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {genSettings?.show && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={()=>setGenSettings(null)}>
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-slate-800 mb-6">{TEXT.genSettings}</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">{TEXT.totalStaff}</label>
                                        <input type="number" value={genSettings.total} onChange={e=>setGenSettings({...genSettings, total: parseInt(e.target.value)})} className="w-full border border-slate-300 rounded-lg p-3 text-lg font-semibold text-center" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">{TEXT.morningStaff}</label>
                                        <input type="number" value={genSettings.morning} onChange={e=>setGenSettings({...genSettings, morning: parseInt(e.target.value)})} className="w-full border border-slate-300 rounded-lg p-3 text-lg font-semibold text-center" />
                                    </div>
                                </div>
                                <div className="flex flex-col gap-3 mt-8">
                                    {isOptimizing ? (
                                        <div className="text-center py-4 text-blue-600 font-bold animate-pulse">{TEXT.optimizing}</div>
                                    ) : (
                                        <>
                                            <div className="flex gap-3">
                                                <button onClick={()=>runGenerator(false)} className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow hover:bg-blue-700 transition">{TEXT.generate}</button>
                                                <button onClick={()=>runGenerator(true)} className="flex-1 py-3 bg-emerald-600 text-white font-bold rounded-xl shadow hover:bg-emerald-700 transition">{TEXT.optimizeBtn}</button>
                                            </div>
                                            <button onClick={()=>setGenSettings(null)} className="w-full py-3 text-slate-500 hover:bg-slate-100 rounded-xl">{TEXT.cancel}</button>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {personToRemove && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={()=>setPersonToRemove(null)}>
                            <div className="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl text-center dark:bg-slate-800" onClick={e=>e.stopPropagation()}>
                                <h3 className="font-bold text-lg text-slate-800 mb-2 dark:text-white">{TEXT.deleteConfirm}</h3>
                                <p className="text-slate-500 text-sm mb-6 dark:text-slate-400">{TEXT.deleteSub}</p>
                                <div className="flex gap-3">
                                    <button onClick={()=>setPersonToRemove(null)} className="flex-1 bg-slate-100 text-slate-700 py-2 rounded-lg font-medium dark:bg-slate-700 dark:text-slate-300">{TEXT.cancel}</button>
                                    <button onClick={archivePerson} className="flex-1 bg-red-600 text-white py-2 rounded-lg font-medium hover:bg-red-700">{TEXT.archive}</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function AuthScreen() {
            const [isReg, setIsReg] = useState(false);
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const [err, setErr] = useState('');
            const [busy, setBusy] = useState(false);

            const handle = async (e) => {
                e.preventDefault();
                setBusy(true); setErr('');
                try {
                    if(isReg) await auth.createUserWithEmailAndPassword(email, pass);
                    else await auth.signInWithEmailAndPassword(email, pass);
                } catch(e) {
                    console.error(e);
                    setErr(TEXT.errorAuth);
                    setBusy(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4 font-sans">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border border-slate-200">
                        <div className="text-center mb-8">
                            <h1 className="text-2xl font-bold text-slate-800">KUTER</h1>
                            <p className="text-slate-500">{TEXT.loginTitle}</p>
                        </div>
                        <form onSubmit={handle} className="space-y-4">
                            <input type="email" required placeholder={TEXT.emailLabel} className="w-full p-3 border border-slate-300 rounded-lg" value={email} onChange={e=>setEmail(e.target.value)} />
                            <input type="password" required placeholder={TEXT.passLabel} className="w-full p-3 border border-slate-300 rounded-lg" value={pass} onChange={e=>setPass(e.target.value)} />
                            {err && <div className="text-red-500 text-sm">{err}</div>}
                            <button disabled={busy} className="w-full bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 transition">
                                {busy ? '...' : isReg ? TEXT.btnRegister : TEXT.btnLogin}
                            </button>
                        </form>
                        <div className="mt-6 text-center">
                            <button onClick={()=>setIsReg(!isReg)} className="text-sm text-blue-600 font-medium hover:underline">
                                {isReg ? "Masz konto? Zaloguj" : "Nie masz konta? Rejestracja"}
                            </button>
                        </div>
                    </div>
                </div>
            )
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
