<!DOCTYPE html>
<html lang="pl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KUTER - System Grafik v0.0.2</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: '#0f172a',      
                        surface: '#1e293b', 
                        surface2: '#334155', 
                        accent: '#3b82f6',  
                        text: '#e2e8f0',    
                        muted: '#94a3b8',   
                        weekend: '#475569', 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; -webkit-tap-highlight-color: transparent; }
        
        .loader {
            border: 3px solid #334155;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Error Handler -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const errDiv = document.createElement('div');
            errDiv.style.cssText = 'color:#ef4444; background:#1e293b; padding:20px; border:1px solid #ef4444; margin:20px; z-index:9999; position:relative; font-family:sans-serif;';
            errDiv.innerHTML = '<h3 style="margin-top:0">CRITICAL ERROR</h3><p>' + message + '</p><p>Line: ' + lineno + '</p>';
            document.body.prepend(errDiv);
        };
        console.log("--- KUTER SYSTEM v0.0.2 LOADED ---");
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDPIZCV4h6Crh254OtZExUaLQtAgjWS1iM",
            authDomain: "grafikmistrz.firebaseapp.com",
            projectId: "grafikmistrz",
            storageBucket: "grafikmistrz.firebasestorage.app",
            messagingSenderId: "605834476831",
            appId: "1:605834476831:web:8da87595b0acb2beb7c42a"
        };

        let app, auth, db;
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (e) { console.error("Init Error", e); }

        // --- TEXTS ---
        const TEXT = {
            defaultAppName: "KUTER",
            appSub: "System v0.0.2",
            tabStaff: "Zesp√≥≈Ç",
            tabCalendar: "Grafik",
            tabStats: "Raporty",
            tabReservations: "Rezerwacje",
            secWaiters: "Obs≈Çuga",
            secBartenders: "Bar",
            addBtn: "Dodaj Pracownika",
            namePlaceholder: "Nazwisko...",
            genBtn: "Generuj",
            optimizeBtn: "Optymalizuj",
            exportGoogle: "üìã Kopiuj",
            dateCol: "Data",
            barCol: "Bar",
            morningCol: "Rano",
            eveningCol: "Popo≈Çudnie",
            loginTitle: "Logowanie",
            btnLogin: "Wejd≈∫",
            btnRegister: "Rejestracja",
            btnLogout: "Wyloguj",
            emailLabel: "Email",
            passLabel: "Has≈Ço",
            archive: "Archiwum",
            settingsTitle: "Ustawienia",
            settGen: "Generator",
            settSys: "System",
            totalStaff: "≈ÅƒÖcznie:",
            morningStaff: "Rano:",
            cancel: "Anuluj",
            save: "Zapisz",
            generate: "Start",
            deleteConfirm: "Archiwizacja",
            deleteSub: "Przenie≈õƒá do archiwum?",
            cleanConfirm: "Wyczy≈õciƒá Archiwum?",
            cleanSub: "To usunie trwale wszystkich archiwalnych pracownik√≥w.",
            cleanBtn: "Usu≈Ñ Trwale",
            headerName: "Nazwa Lokalu",
            errorAuth: "B≈ÇƒÖd danych.",
            copySuccess: "Skopiowano! Wklej (Ctrl+V) w Excelu lub Google Sheets.",
            optimizing: "Przeliczanie...",
            resAddBtn: "+ Nowa Rezerwacja",
            resGridBtn: "üìÖ Kalendarz",
            resAddTitle: "Dodaj / Edytuj Rezerwacjƒô",
            resName: "Nazwisko",
            resTime: "Godz",
            resPax: "Os",
            resTables: "Stolik",
            resDeposit: "Zadatek",
            resTakenBy: "PrzyjƒÖ≈Ç",
            resDate: "Data",
            resNoData: "Brak rezerwacji na ten dzie≈Ñ.",
            resTotalDeposit: "Suma:",
            resStatus: "Status"
        };

        // --- ICONS ---
        const Icons = {
            Menu: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>,
            Close: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
            Users: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            Calendar: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
            Chart: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
            Book: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>,
            Logout: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
            Settings: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
        }

        // --- CLOCK ---
        function LiveClock() {
            const [time, setTime] = useState(new Date());
            useEffect(() => { const t = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(t); }, []);
            return (
                <div className="flex flex-col items-end">
                    <div className="text-xl md:text-2xl font-bold text-accent font-mono tracking-tighter">
                        {time.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                    <div className="text-[10px] text-muted uppercase tracking-widest">
                        {time.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' })}
                    </div>
                </div>
            );
        }

        // --- APP COMPONENT ---
        function App() {
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [people, setPeople] = useState([]);
            const [schedule, setSchedule] = useState({});
            const [holidays, setHolidays] = useState([]);
            const [reservations, setReservations] = useState({});
            
            const [activeTab, setActiveTab] = useState('staff');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [loading, setLoading] = useState(true);
            const [menuOpen, setMenuOpen] = useState(false);
            const [appTitle, setAppTitle] = useState(localStorage.getItem('appTitle') || TEXT.defaultAppName);
            
            const [newName, setNewName] = useState('');
            const [newGender, setNewGender] = useState('male');
            const [newRole, setNewRole] = useState('waiter');
            
            const [addingToSlot, setAddingToSlot] = useState(null);
            const [personToRemove, setPersonToRemove] = useState(null);
            const [showSettings, setShowSettings] = useState(false); 
            const [showAddStaff, setShowAddStaff] = useState(false); 
            const [settingsTab, setSettingsTab] = useState('gen');
            
            const [genTotal, setGenTotal] = useState(4);
            const [genMorning, setGenMorning] = useState(2);
            const [isOptimizing, setIsOptimizing] = useState(false);

            const [showResGrid, setShowResGrid] = useState(false);
            const [showResForm, setShowResForm] = useState(false);
            const [editingResId, setEditingResId] = useState(null);
            const [resSelectedDate, setResSelectedDate] = useState(new Date());
            const [newResData, setNewResData] = useState({ name: '', time: '12:00', pax: 2, tables: '', deposit: 0, takenBy: '', status: 'pending' });
            const [confirmClean, setConfirmClean] = useState(false);

            useEffect(() => { const u = auth.onAuthStateChanged(u => { setUser(u); setIsAuthReady(true); if(!u){setPeople([]);setSchedule({});setReservations({})} }); return () => u(); }, []);
            useEffect(() => {
                if(!user || !db) return;
                setLoading(true);
                const r = `artifacts/${firebaseConfig.projectId}/users/${user.uid}`;
                const u1 = db.collection(`${r}/people`).onSnapshot(s => setPeople(s.docs.map(d=>({id:d.id,...d.data()}))));
                const u2 = db.doc(`${r}/appData/schedule`).onSnapshot(s => setSchedule(s.data()||{}));
                const u3 = db.doc(`${r}/appData/holidays`).onSnapshot(s => setHolidays(s.data()?.dates||[]));
                const u4 = db.doc(`${r}/appData/reservations`).onSnapshot(s => { setReservations(s.data()||{}); setLoading(false); });
                return () => { u1(); u2(); u3(); u4(); };
            }, [user]);

            const getPerson = (id) => people.find(p => p.id === id);
            const getUserRef = () => `artifacts/${firebaseConfig.projectId}/users/${user.uid}`;
            const getMonthName = (d) => d.toLocaleString('pl-PL', { month: 'long', year: 'numeric' });
            const changeMonth = (d) => { const n = new Date(currentDate); n.setMonth(n.getMonth()+d); setCurrentDate(n); };
            const getBarmanArray = (s) => (!s || !s.barman) ? [] : (Array.isArray(s.barman) ? s.barman : [s.barman]);
            const saveTitle = (val) => { setAppTitle(val); localStorage.setItem('appTitle', val); };

            const stats = useMemo(() => {
                const s = {}; people.forEach(p => s[p.id] = { h: 0, covers: 0 });
                const dim = new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate();
                for(let i=1; i<=dim; i++) {
                    const dStr = new Date(currentDate.getFullYear(), currentDate.getMonth(), i).toLocaleDateString('en-CA');
                    const dw = new Date(currentDate.getFullYear(), currentDate.getMonth(), i).getDay();
                    const sh = schedule[dStr];
                    if(sh) {
                        const bms = getBarmanArray(sh);
                        bms.forEach((bid, idx) => {
                            if(s[bid]) {
                                let h = 12; if(dw===5 && idx>0) h=7; else if(dw===0 && idx>0) h=6;
                                s[bid].h += h; if(getPerson(bid)?.role==='waiter') s[bid].covers++;
                            }
                        });
                        sh.morning.forEach(id=>{if(s[id]) s[id].h+=10});
                        sh.evening.forEach(id=>{if(s[id]) s[id].h+=12});
                    }
                }
                return s;
            }, [people, schedule, currentDate]);

            const getStreak = (pid, dStr) => {
                const d = new Date(dStr); let st = 0;
                for(let i=1; i<=5; i++) {
                    const pStr = new Date(d.getFullYear(), d.getMonth(), d.getDate()-i).toLocaleDateString('en-CA');
                    const s = schedule[pStr];
                    if(s && (getBarmanArray(s).includes(pid) || s.morning.includes(pid) || s.evening.includes(pid))) st++; else break;
                }
                return st;
            };

            const addPerson = async () => { if(!newName.trim())return; await db.collection(`${getUserRef()}/people`).add({name:newName.trim(), gender:newGender, role:newRole, daysOff:[], archived:false}); setNewName(''); setShowAddStaff(false); };
            const archivePerson = async () => { if(personToRemove) { await db.doc(`${getUserRef()}/people/${personToRemove}`).update({archived:true}); setPersonToRemove(null); }};
            const cleanArchive = async () => {
                const archived = people.filter(p => p.archived);
                const batch = db.batch();
                archived.forEach(p => { const ref = db.collection(`${getUserRef()}/people`).doc(p.id); batch.delete(ref); });
                await batch.commit(); setConfirmClean(false);
            };

            const toggleDayOff = async (pid, day) => {
                const p = getPerson(pid); if(!p)return;
                const dStr = new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toLocaleDateString('en-CA');
                const no = p.daysOff.includes(dStr) ? p.daysOff.filter(d=>d!==dStr) : [...p.daysOff, dStr];
                await db.doc(`${getUserRef()}/people/${pid}`).update({daysOff:no});
            };
            const toggleHoliday = async (ds) => { 
                const nh = holidays.includes(ds) ? holidays.filter(d=>d!==ds) : [...holidays, ds]; 
                await db.doc(`${getUserRef()}/appData/holidays`).set({dates:nh}); 
            };
            const removeFromShift = async (ds, t, pid) => {
                const s = schedule[ds]; if(!s)return; const ns={...s};
                if(t==='bar'){ const b=getBarmanArray(s); ns.barman=b.filter(x=>x!==pid); } else ns[t]=s[t].filter(x=>x!==pid);
                await db.doc(`${getUserRef()}/appData/schedule`).update({[ds]:ns});
            };
            const addToShift = async (ds, t, pid) => {
                const s = schedule[ds]||{date:ds,morning:[],evening:[],barman:[]}; const ns={...s};
                if(t==='bar'){ const b=getBarmanArray(s); ns.barman=[...b,pid]; } else ns[t]=[...ns[t]||[], pid];
                await db.doc(`${getUserRef()}/appData/schedule`).set({[ds]:ns}, {merge:true}); setAddingToSlot(null);
            };
            
            const saveReservation = async () => {
                if (!newResData.name) return;
                const ds = resSelectedDate.toLocaleDateString('en-CA');
                const list = reservations[ds] || [];
                let uList;
                if (editingResId) { uList = list.map(r => r.id === editingResId ? { ...newResData, id: editingResId } : r); } 
                else { const nr = { id: Date.now().toString(), ...newResData }; uList = [...list, nr]; }
                await db.doc(`${getUserRef()}/appData/reservations`).set({ ...reservations, [ds]: uList }, { merge: true });
                setEditingResId(null); setNewResData({ name: '', time: '12:00', pax: 2, tables: '', deposit: 0, takenBy: '', status: 'pending' }); setShowResForm(false);
            };
            const openResForm = (res = null) => {
                if (res) { setEditingResId(res.id); setNewResData({ ...res }); }
                else { setEditingResId(null); setNewResData({ name: '', time: '12:00', pax: 2, tables: '', deposit: 0, takenBy: '', status: 'pending' }); }
                setShowResForm(true);
            };
            const removeReservation = async (ds, rid) => { const list = reservations[ds]||[]; await db.doc(`${getUserRef()}/appData/reservations`).update({ [ds]: list.filter(r => r.id !== rid) }); };
            const toggleResStatus = async (ds, rid) => { const list = reservations[ds]||[]; const uList = list.map(r => r.id === rid ? { ...r, status: r.status === 'pending' ? 'done' : r.status === 'done' ? 'cancelled' : 'pending' } : r); await db.doc(`${getUserRef()}/appData/reservations`).update({ [ds]: uList }); };

            const generateScheduleData = (pl, y, m, tot, morn) => {
                try {
                    const dc = new Date(y, m + 1, 0).getDate();
                    let pool = pl.filter(p => !p.archived).map(p => ({ ...p, hours: 0, streak: 0, barCount: 0 }));
                    const newSched = {};
                    const getScore = (p, r) => { let s = p.hours; if(p.streak >= 4) s += 1000; if(r==='bartender' && p.role==='waiter') s += (p.barCount * 50); return s + Math.random() * 10; };

                    for(let day = 1; day <= dc; day++) {
                        const dStr = new Date(y, m, day).toLocaleDateString('en-CA');
                        const dw = new Date(y, m, day).getDay();
                        const avail = pool.filter(p => !p.daysOff.includes(dStr));
                        let sb = []; let rb = avail.filter(p => p.role === 'bartender').sort((a,b) => getScore(a,'bartender') - getScore(b,'bartender'));
                        const isWk = (dw === 5 || dw === 6 || dw === 0); const nb = isWk ? 2 : 1;
                        let safe = 0;
                        while (sb.length < nb && rb.length > 0 && safe < 50) { sb.push(rb.shift()); safe++; }
                        if (sb.length < nb) {
                            let wb = avail.filter(p => p.role === 'waiter' && !sb.includes(p)).sort((a,b) => getScore(a,'bartender') - getScore(b,'bartender'));
                            safe = 0; while (sb.length < nb && wb.length > 0 && safe < 50) { const w = wb.shift(); sb.push(w); pool.find(p => p.id === w.id).barCount++; safe++; }
                        }
                        sb.forEach((bm, idx) => { const p = pool.find(x => x.id === bm.id); let h = 12; if (dw === 5 && idx > 0) h = 7; else if (dw === 0 && idx > 0) h = 6; p.hours += h; p.streak++; });
                        const bIds = sb.map(b => b.id);
                        let wc = avail.filter(p => p.role === 'waiter' && !bIds.includes(p.id));
                        const bMale = sb.some(b => b.gender === 'male');
                        let sw = [];
                        if(!bMale) { const m = wc.filter(w => w.gender === 'male').sort((a,b) => getScore(a,'waiter') - getScore(b,'waiter')); if(m.length > 0 && m[0].streak < 5) { sw.push(m[0]); wc = wc.filter(x => x.id !== m[0].id); } }
                        wc.sort((a,b) => getScore(a,'waiter') - getScore(b,'waiter'));
                        safe = 0; while(sw.length < tot && wc.length > 0 && safe < 50) { sw.push(wc.shift()); safe++; }
                        sw.forEach(w => { const p = pool.find(x => x.id === w.id); p.hours += 10.5; p.streak++; });
                        const wIds = [...bIds, ...sw.map(w=>w.id)];
                        pool.forEach(p => { if(!wIds.includes(p.id)) p.streak = 0; });
                        sw.sort((a,b) => a.hours - b.hours);
                        newSched[dStr] = { barman: bIds, morning: sw.slice(0, morn).map(w=>w.id), evening: sw.slice(morn).map(w=>w.id) };
                    }
                    const hrs = pool.map(p => p.hours); return { schedule: newSched, diff: Math.max(...hrs) - Math.min(...hrs) };
                } catch (err) { console.error(err); return { schedule: {}, diff: 99999 }; }
            };

            const runGenerator = async (opt) => {
                if(!genSettings) return;
                const { total, morning } = genSettings;
                if (opt) {
                    setIsOptimizing(true);
                    setTimeout(async () => {
                        let best = null; for(let i=0; i<20; i++) { const res = generateScheduleData(people, currentDate.getFullYear(), currentDate.getMonth(), total, morning); if (!best || res.diff < best.diff) best = res; }
                        if(best) await db.doc(`${getUserRef()}/appData/schedule`).set(best.schedule, {merge: true});
                        setIsOptimizing(false); setShowSettings(false); setActiveTab('calendar');
                    }, 100);
                } else {
                    const res = generateScheduleData(people, currentDate.getFullYear(), currentDate.getMonth(), total, morning);
                    await db.doc(`${getUserRef()}/appData/schedule`).set(res.schedule, {merge: true});
                    setShowSettings(false); setActiveTab('calendar');
                }
            };
            
            const openGenSettings = () => { const h = currentDate.getMonth() >= 4 && currentDate.getMonth() <= 8; setGenTotal(h ? 6 : 4); setGenMorning(h ? 3 : 2); setSettingsTab('gen'); setShowSettings(true); };
            
            // --- COPY WITH FORMATTING ---
            const copyToClipboard = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const dim = new Date(year, month + 1, 0).getDate();

                // 1. Plain Text (TSV)
                let tsv = "Data\tBar\tRano\tPopo≈Çudnie\n";

                // 2. HTML for formatting (Colors mapped to Hex)
                let html = `<table border="1" style="border-collapse: collapse; font-family: Arial, sans-serif;">
                    <thead>
                        <tr style="background-color: #f3f4f6; font-weight: bold;">
                            <th style="padding: 5px;">Data</th>
                            <th style="padding: 5px; background-color: #e0e7ff; color: #312e81;">Bar</th>
                            <th style="padding: 5px; background-color: #ffedd5; color: #7c2d12;">Rano</th>
                            <th style="padding: 5px; background-color: #dbeafe; color: #1e3a8a;">Popo≈Çudnie</th>
                        </tr>
                    </thead>
                    <tbody>`;

                for (let d = 1; d <= dim; d++) {
                    const date = new Date(year, month, d);
                    const ds = date.toLocaleDateString('en-CA');
                    const s = schedule[ds] || { morning: [], evening: [], barman: [] };
                    
                    const isHol = holidays.includes(ds);
                    const isWknd = [0, 6].includes(date.getDay());

                    // Row Styling
                    let rowBg = "#ffffff";
                    if (isHol) rowBg = "#fee2e2"; // Light Red
                    else if (isWknd) rowBg = "#f1f5f9"; // Light Gray

                    // Data
                    const dateStr = `${date.toLocaleDateString('pl-PL')} ${date.toLocaleDateString('pl-PL', {weekday: 'short'})}`;
                    const barmen = getBarmanArray(s).map(id => getPerson(id)?.name || "").join(", ");
                    const morn = s.morning.map(id => getPerson(id)?.name || "").join(", ");
                    const eve = s.evening.map(id => getPerson(id)?.name || "").join(", ");

                    // Build TSV
                    tsv += `${dateStr}\t${barmen}\t${morn}\t${eve}\n`;

                    // Build HTML
                    html += `<tr style="background-color: ${rowBg};">
                        <td style="padding: 5px; border: 1px solid #d1d5db;">${dateStr} ${isHol ? '‚òÖ' : ''}</td>
                        <td style="padding: 5px; border: 1px solid #d1d5db; color: #312e81;">${barmen}</td>
                        <td style="padding: 5px; border: 1px solid #d1d5db; color: #7c2d12;">${morn}</td>
                        <td style="padding: 5px; border: 1px solid #d1d5db; color: #1e3a8a;">${eve}</td>
                    </tr>`;
                }

                // Add Report Section to Copy
                html += `<tr><td colspan="4" style="border:none; height:20px;"></td></tr>
                         <tr><td colspan="4" style="font-weight:bold; font-size:14px; border:none;">RAPORT GODZIN:</td></tr>
                         <tr><td colspan="4" style="border:none;"><div style="display:flex; flex-wrap:wrap; gap:10px;">`;
                
                people.filter(p => !p.archived).forEach(p => {
                    const h = stats[p.id]?.h || 0;
                    html += `<span style="border:1px solid #ccc; padding:2px 5px; margin-right:5px;">${p.name}: ${h}h</span>`;
                });
                
                html += `</div></td></tr></tbody></table>`;

                // Copy Logic
                const blobText = new Blob([tsv], { type: 'text/plain' });
                const blobHtml = new Blob([html], { type: 'text/html' });
                
                try {
                    const item = new ClipboardItem({ 
                        "text/plain": blobText, 
                        "text/html": blobHtml 
                    });
                    navigator.clipboard.write([item]).then(
                        () => alert(TEXT.copySuccess),
                        (err) => {
                            console.error("Clipboard write failed", err);
                            navigator.clipboard.writeText(tsv).then(() => alert(TEXT.copySuccess));
                        }
                    );
                } catch (e) {
                     navigator.clipboard.writeText(tsv).then(() => alert(TEXT.copySuccess));
                }
            };

            if(!isAuthReady) return <div className="flex h-screen items-center justify-center bg-bg text-text"><div className="loader"></div></div>;
            if(!user) return <AuthScreen />;

            return (
                <div className="min-h-screen flex bg-bg text-text">
                    {/* SIDEBAR */}
                    <div className={`fixed inset-0 z-50 flex ${menuOpen ? '' : 'pointer-events-none'}`}>
                        <div className={`fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300 ${menuOpen ? 'opacity-100' : 'opacity-0'}`} onClick={() => setMenuOpen(false)} />
                        <div className={`relative w-72 bg-surface shadow-2xl border-r border-surface2 flex flex-col transform transition-transform duration-300 ${menuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                            <div className="h-24 flex items-center px-6 border-b border-surface2 bg-bg/50">
                                <div className="h-10 w-10 bg-surface rounded-full border border-surface2 flex items-center justify-center mr-4 overflow-hidden"><img src="logo.jpg" className="h-full w-full object-cover opacity-80" onError={(e)=>{e.target.style.display='none'}} /></div>
                                <h2 className="font-bold text-lg tracking-wide text-white">{appTitle}</h2>
                            </div>
                            <div className="flex-grow py-6 px-3 space-y-1">
                                {[{ id: 'staff', label: TEXT.tabStaff, icon: <Icons.Users /> },{ id: 'calendar', label: TEXT.tabCalendar, icon: <Icons.Calendar /> },{ id: 'reservations', label: TEXT.tabReservations, icon: <Icons.Book /> },{ id: 'stats', label: TEXT.tabStats, icon: <Icons.Chart /> }].map(item => (
                                    <button key={item.id} onClick={() => { setActiveTab(item.id); setMenuOpen(false); }} className={`w-full flex items-center gap-4 px-4 py-3.5 rounded-xl transition-all duration-200 font-medium ${activeTab === item.id ? 'bg-accent text-white shadow-lg shadow-blue-900/20' : 'text-muted hover:bg-surface2 hover:text-white'}`}>
                                        {item.icon} <span>{item.label}</span>
                                    </button>
                                ))}
                            </div>
                            <div className="p-6 border-t border-surface2"><button onClick={() => auth.signOut()} className="flex items-center gap-3 text-muted hover:text-red-400 transition text-sm"><Icons.Logout /> {TEXT.btnLogout}</button></div>
                        </div>
                    </div>

                    {/* MAIN */}
                    <div className="flex-grow flex flex-col h-screen overflow-hidden">
                        <header className="h-16 bg-surface/80 backdrop-blur border-b border-surface2 flex items-center justify-between px-4 md:px-8 no-print shrink-0">
                            <button onClick={() => setMenuOpen(true)} className="p-2 rounded-lg hover:bg-surface2 text-muted hover:text-white transition"><Icons.Menu /></button>
                            <div className="flex items-center gap-6">
                                <div className="hidden md:block text-right border-r border-surface2 pr-6"><LiveClock /></div>
                                <div className="flex items-center bg-surface2 rounded-lg p-0.5">
                                    <button onClick={() => changeMonth(-1)} className="p-1.5 hover:bg-bg rounded text-muted hover:text-white">‚óÄ</button>
                                    <span className="px-3 text-sm font-medium min-w-[100px] text-center capitalize">{getMonthName(currentDate)}</span>
                                    <button onClick={() => changeMonth(1)} className="p-1.5 hover:bg-bg rounded text-muted hover:text-white">‚ñ∂</button>
                                </div>
                            </div>
                        </header>

                        <div className="flex-grow overflow-y-auto p-4 md:p-8">
                            {/* TITLE */}
                            <div className="mb-4 border-b border-surface2 pb-2 flex justify-between items-end">
                                <h1 className="text-2xl font-bold text-white">{appTitle} - {activeTab==='reservations' ? TEXT.tabReservations : 'Grafik'}: {getMonthName(currentDate)}</h1>
                            </div>

                            {/* STAFF */}
                            {activeTab === 'staff' && (
                                <div className="max-w-5xl mx-auto space-y-6">
                                    <div className="flex justify-between items-center no-print">
                                        <h2 className="text-2xl font-bold text-white">Zesp√≥≈Ç</h2>
                                        <button onClick={()=>setShowAddStaff(true)} className="bg-accent hover:bg-blue-600 text-white font-medium px-6 py-2 rounded-xl transition shadow-lg">{TEXT.addBtn}</button>
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        {[TEXT.secWaiters, TEXT.secBartenders].map((title, idx) => {
                                            const role = idx === 0 ? 'waiter' : 'bartender';
                                            return (
                                                <div key={role} className="bg-surface border border-surface2 rounded-2xl overflow-hidden shadow-lg">
                                                    <div className="px-6 py-4 bg-bg/50 border-b border-surface2 font-semibold text-muted uppercase tracking-wider text-xs">{title}</div>
                                                    <div className="p-4 space-y-3">
                                                        {people.filter(p => p.role === role && !p.archived).map(p => (
                                                            <div key={p.id} className="bg-bg border border-surface2 rounded-xl p-3 hover:border-surface2/80 transition group">
                                                                <div className="flex justify-between items-center mb-3">
                                                                    <div className="font-medium text-white flex items-center gap-2"><span className="text-lg">{p.gender === 'male' ? 'üë®' : 'üë©'}</span> {p.name}</div>
                                                                    <button onClick={()=>setPersonToRemove(p.id)} className="text-surface2 hover:text-red-400 transition no-print opacity-0 group-hover:opacity-100 p-1">üóëÔ∏è</button>
                                                                </div>
                                                                <div className="flex flex-wrap gap-1 no-print">
                                                                    {Array.from({length: new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate()}, (_, i)=>i+1).map(d => {
                                                                        const dObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), d);
                                                                        const dStr = dObj.toLocaleDateString('en-CA');
                                                                        const isOff = p.daysOff.includes(dStr);
                                                                        const isWknd = [0, 5, 6].includes(dObj.getDay());
                                                                        let btnClass = "bg-surface2 text-muted hover:bg-accent hover:text-white";
                                                                        if (isWknd) btnClass = "bg-weekend text-slate-300 hover:bg-accent hover:text-white";
                                                                        if (isOff) btnClass = "bg-red-500/20 text-red-400 border border-red-500/50";
                                                                        return <button key={d} onClick={()=>toggleDayOff(p.id, d)} className={`w-8 h-8 text-xs rounded-lg font-medium transition border border-transparent ${btnClass}`}>{d}</button>
                                                                    })}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                    <div className="fixed bottom-6 right-6 no-print z-30"><button onClick={openGenSettings} className="bg-accent hover:bg-blue-600 text-white h-14 w-14 rounded-full shadow-xl shadow-blue-900/30 flex items-center justify-center text-2xl transition transform hover:scale-110"><Icons.Settings /></button></div>
                                </div>
                            )}

                            {/* CALENDAR */}
                            {activeTab === 'calendar' && (
                                <div className="max-w-full mx-auto bg-surface border border-surface2 rounded-2xl overflow-hidden shadow-lg">
                                    <div className="p-4 border-b border-surface2 flex justify-between items-center bg-bg/30 no-print">
                                        <div className="text-xs text-muted uppercase font-bold tracking-wider">Grafik Zmian</div>
                                        <div className="flex gap-2">
                                            <button onClick={copyToClipboard} className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-lg shadow-emerald-900/20 flex items-center gap-2">
                                                {TEXT.exportGoogle}
                                            </button>
                                        </div>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left border-collapse min-w-[600px]">
                                            <thead>
                                                <tr className="text-xs uppercase text-muted tracking-wider border-b border-surface2 bg-bg/50">
                                                    <th className="p-4 font-semibold w-20 border-r border-surface2">{TEXT.dateCol}</th>
                                                    <th className="p-4 font-semibold w-1/4 border-r border-surface2 text-indigo-400">{TEXT.barCol}</th>
                                                    <th className="p-4 font-semibold w-1/3 border-r border-surface2 text-orange-400">{TEXT.morningCol}</th>
                                                    <th className="p-4 font-semibold w-1/3 text-blue-400">{TEXT.eveningCol}</th>
                                                </tr>
                                            </thead>
                                            <tbody className="text-sm divide-y divide-surface2">
                                                {Array.from({length: new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate()}, (_, i)=>i+1).map(d => {
                                                    const dObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), d);
                                                    const dStr = dObj.toLocaleDateString('en-CA');
                                                    const isHol = holidays.includes(dStr);
                                                    const isWknd = [0, 6].includes(dObj.getDay());
                                                    const s = schedule[dStr] || { barman: [], morning: [], evening: [] };
                                                    const rowClass = isHol ? 'bg-red-900/10' : isWknd ? 'bg-bg/30' : '';
                                                    const Badge = ({uid, type, onDelete}) => {
                                                        const p = getPerson(uid); if(!p)return null;
                                                        const st = getStreak(uid, dStr);
                                                        const isCover = type === 'bar' && p.role === 'waiter';
                                                        let cls = "";
                                                        if(type==='bar') cls = isCover ? "bg-yellow-900/30 text-yellow-200 border-yellow-700" : "bg-indigo-900/30 text-indigo-200 border-indigo-700";
                                                        else if(type==='morn') cls = "bg-orange-900/30 text-orange-200 border-orange-700";
                                                        else cls = "bg-blue-900/30 text-blue-200 border-blue-700";
                                                        return <span className={`inline-flex items-center px-2 py-1 rounded-md text-xs border mr-1 mb-1 ${cls}`}>{p.name} {isCover && '‚ö†Ô∏è'} {st>=4 && 'üî•'}<button onClick={onDelete} className="ml-1.5 opacity-50 hover:opacity-100 hover:text-red-400 no-print">√ó</button></span>
                                                    }
                                                    return (
                                                        <tr key={d} className={`group hover:bg-surface2/10 transition ${rowClass}`}>
                                                            <td className="p-3 align-top border-r border-surface2 relative">
                                                                <div className="font-bold text-lg text-white leading-none">{d}</div>
                                                                <div className="text-[10px] text-muted uppercase mt-1">{dObj.toLocaleDateString('pl-PL', {weekday:'short'})}</div>
                                                                <button onClick={()=>toggleHoliday(dStr)} className={`absolute top-2 right-1 text-sm no-print ${isHol?'text-yellow-500':'text-surface2 hover:text-yellow-500'}`}>‚òÖ</button>
                                                            </td>
                                                            {['bar', 'morning', 'evening'].map(t => (
                                                                <td key={t} className="p-2 align-top border-r border-surface2 relative last:border-0">
                                                                    <div className="min-h-[30px] flex flex-wrap content-start">
                                                                        {(t==='bar'?getBarmanArray(s):s[t]).map(id => <Badge key={id} uid={id} type={t==='morning'?'morn':t==='evening'?'eve':'bar'} onDelete={()=>removeFromShift(dStr, t, id)} />)}
                                                                        <button className="absolute bottom-0 right-0 p-1 text-surface2 hover:text-accent no-print opacity-0 group-hover:opacity-100 transition" onClick={()=>setAddingToSlot({date:dStr, type:t})}>‚ûï</button>
                                                                    </div>
                                                                </td>
                                                            ))}
                                                        </tr>
                                                    )
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {/* --- RESERVATIONS --- */}
                            {activeTab === 'reservations' && (
                                <div className="space-y-6">
                                    <div className="flex justify-between items-center no-print bg-surface p-4 rounded-2xl border border-surface2">
                                        <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                            <span className="text-accent">{resSelectedDate.toLocaleDateString('pl-PL', {weekday:'long', day:'numeric', month:'long'})}</span>
                                        </h2>
                                        <div className="flex gap-2">
                                            <button onClick={()=>setShowResForm(true)} className="bg-accent hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition">{TEXT.resAddBtn}</button>
                                            <button onClick={()=>setShowResGrid(true)} className="bg-surface2 hover:bg-bg text-white px-4 py-2 rounded-lg font-medium transition">{TEXT.resGridBtn}</button>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-surface border border-surface2 rounded-2xl overflow-hidden shadow-lg">
                                        <div className="p-4 border-b border-surface2 bg-bg/30 flex justify-between items-center">
                                            <span className="text-xs font-bold text-muted uppercase tracking-wider">Lista Go≈õci</span>
                                            <span className="text-sm text-green-400 font-mono">{TEXT.resTotalDeposit} {(reservations[resSelectedDate.toLocaleDateString('en-CA')] || []).reduce((acc, r) => acc + parseFloat(r.deposit || 0), 0)} PLN</span>
                                        </div>
                                        <div className="p-0">
                                            {(reservations[resSelectedDate.toLocaleDateString('en-CA')] || []).sort((a,b) => a.time.localeCompare(b.time)).map(r => (
                                                <div key={r.id} className={`flex flex-col md:flex-row md:items-center p-4 border-b border-surface2 last:border-0 hover:bg-white/5 transition cursor-pointer ${r.status==='done'?'opacity-50':''}`} onClick={() => openResForm(r)}>
                                                    <div className="w-20 font-mono font-bold text-xl text-accent mb-1 md:mb-0">{r.time}</div>
                                                    <div className="flex-grow pl-0 md:pl-4">
                                                        <div className="font-bold text-white text-lg">{r.name}</div>
                                                        <div className="text-sm text-muted flex flex-wrap gap-3 mt-1">
                                                            <span>üë• {r.pax} os.</span>
                                                            <span>ü™ë Stolik: {r.tables || "-"}</span>
                                                            <span className="text-green-400">üí∞ Zadatek: {r.deposit}</span>
                                                            <span className="text-indigo-400">üìù PrzyjƒÖ≈Ç: {r.takenBy || "-"}</span>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2 mt-3 md:mt-0 no-print" onClick={e => e.stopPropagation()}>
                                                        <button onClick={()=>toggleResStatus(resSelectedDate.toLocaleDateString('en-CA'), r.id)} 
                                                            className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition ${r.status==='done' ? 'border-green-500 text-green-500' : r.status==='cancelled' ? 'border-red-500 text-red-500' : 'border-surface2 text-muted hover:border-white'}`}>
                                                            {r.status==='done' ? '‚úì OK' : r.status==='cancelled' ? '‚úï' : '? OCZEKUJE'}
                                                        </button>
                                                        <button onClick={() => removeReservation(resSelectedDate.toLocaleDateString('en-CA'), r.id)} className="w-8 h-8 rounded-lg bg-surface2 text-muted hover:text-red-400 flex items-center justify-center">√ó</button>
                                                    </div>
                                                </div>
                                            ))}
                                            {!(reservations[resSelectedDate.toLocaleDateString('en-CA')] || []).length && (
                                                <div className="p-12 text-center text-muted italic">{TEXT.resNoData}</div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* --- STATS --- */}
                            {activeTab === 'stats' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {[TEXT.secWaiters, TEXT.secBartenders].map((title, idx) => {
                                        const role = idx === 0 ? 'waiter' : 'bartender';
                                        const maxHours = Math.max(...Object.values(stats).map(s=>s.h), 1);
                                        const list = people.filter(p => p.role === role && (!p.archived || stats[p.id]?.h > 0)).sort((a,b) => stats[b.id].h - stats[a.id].h);
                                        return (
                                            <div key={role} className="bg-surface border border-surface2 rounded-2xl overflow-hidden shadow-lg">
                                                <div className="px-6 py-4 bg-bg/50 border-b border-surface2 font-semibold text-muted uppercase tracking-wider text-xs">{title}</div>
                                                <div className="p-4 space-y-4">
                                                    {list.map(p => (
                                                        <div key={p.id}>
                                                            <div className="flex justify-between text-sm mb-2 font-medium">
                                                                <span className={`text-white ${p.archived ? 'line-through text-muted' : ''}`}>{p.name}</span>
                                                                <span className="text-muted font-mono">{stats[p.id].h}h {role==='waiter' && stats[p.id].covers > 0 && <span className="text-yellow-500 ml-2">({stats[p.id].covers}B)</span>}</span>
                                                            </div>
                                                            <div className="w-full bg-bg rounded-full h-2 overflow-hidden border border-surface2">
                                                                <div className={`h-full rounded-full ${role==='waiter'?'bg-accent':'bg-indigo-500'} ${p.archived?'opacity-50':''}`} style={{width: `${(stats[p.id].h / maxHours) * 100}%`}}></div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* MODALS */}
                    {/* ADD STAFF MODAL */}
                    {showAddStaff && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={()=>setShowAddStaff(false)}>
                            <div className="bg-surface border border-surface2 rounded-2xl w-full max-w-sm p-6 shadow-2xl" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-white mb-6">{TEXT.addBtn}</h3>
                                <div className="space-y-4">
                                    <input value={newName} onChange={e=>setNewName(e.target.value)} placeholder={TEXT.namePlaceholder} className="w-full bg-bg border border-surface2 rounded-xl px-4 py-3 focus:ring-1 focus:ring-accent outline-none text-white" />
                                    <div className="flex gap-2">
                                        <select value={newGender} onChange={e=>setNewGender(e.target.value)} className="bg-bg border border-surface2 rounded-xl px-4 py-3 outline-none text-white w-1/2"><option value="male">Ch≈Çopak</option><option value="female">Dziewczyna</option></select>
                                        <select value={newRole} onChange={e=>setNewRole(e.target.value)} className="bg-bg border border-surface2 rounded-xl px-4 py-3 outline-none text-white w-1/2"><option value="waiter">Kelner</option><option value="bartender">Barman</option></select>
                                    </div>
                                </div>
                                <div className="flex gap-3 mt-8">
                                    <button onClick={()=>setShowAddStaff(false)} className="flex-1 py-3 text-muted hover:text-white transition">{TEXT.cancel}</button>
                                    <button onClick={addPerson} className="flex-1 py-3 bg-accent hover:bg-blue-600 text-white rounded-xl font-bold transition shadow-lg">Zapisz</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* RES CALENDAR MODAL */}
                    {showResGrid && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={()=>setShowResGrid(false)}>
                            <div className="bg-surface border border-surface2 rounded-2xl w-full max-w-md p-6 shadow-2xl" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-white mb-4">Wybierz Datƒô</h3>
                                <div className="grid grid-cols-7 gap-2 text-center">
                                    {['Pn','Wt','≈ör','Cz','Pt','Sb','Nd'].map(d=><div key={d} className="text-xs text-muted font-bold py-2">{d}</div>)}
                                    {(() => {
                                        const y = currentDate.getFullYear(), m = currentDate.getMonth();
                                        const firstDay = new Date(y, m, 1).getDay(); const offset = firstDay === 0 ? 6 : firstDay - 1;
                                        const dim = new Date(y, m + 1, 0).getDate();
                                        let slots = [];
                                        for(let i=0; i<offset; i++) slots.push(<div key={`e-${i}`}></div>);
                                        for(let d=1; d<=dim; d++) {
                                            const dObj = new Date(y, m, d);
                                            const dStr = dObj.toLocaleDateString('en-CA');
                                            const has = (reservations[dStr] && reservations[dStr].length > 0);
                                            const sel = resSelectedDate.getDate() === d;
                                            slots.push(
                                                <button key={d} onClick={() => { setResSelectedDate(dObj); setShowResGrid(false); }}
                                                    className={`h-10 rounded-lg flex items-center justify-center relative transition text-sm font-medium
                                                        ${sel ? 'bg-accent text-white shadow-lg' : 'bg-bg border border-surface2 hover:bg-surface2 text-slate-300'}
                                                    `}
                                                >
                                                    {d}
                                                    {has && <span className="absolute bottom-1 w-1 h-1 bg-green-400 rounded-full"></span>}
                                                </button>
                                            );
                                        }
                                        return slots;
                                    })()}
                                </div>
                                <button onClick={()=>setShowResGrid(false)} className="w-full mt-6 py-3 text-muted hover:text-white transition">Zamknij</button>
                            </div>
                        </div>
                    )}

                    {/* RES FORM MODAL */}
                    {showResForm && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={()=>setShowResForm(false)}>
                            <div className="bg-surface border border-surface2 rounded-2xl w-full max-w-md p-6 shadow-2xl" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-white mb-6">{TEXT.resAddTitle}</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-[10px] font-bold text-muted uppercase mb-1 block">{TEXT.resName}</label>
                                        <input className="w-full bg-bg border border-surface2 p-3 rounded-xl text-white focus:border-accent outline-none" value={newResData.name} onChange={e => setNewResData({...newResData, name: e.target.value})} />
                                    </div>
                                    <div className="flex gap-3">
                                        <div className="flex-1">
                                            <label className="text-[10px] font-bold text-muted uppercase mb-1 block">{TEXT.resTime}</label>
                                            <input type="time" className="w-full bg-bg border border-surface2 p-3 rounded-xl text-white focus:border-accent outline-none" value={newResData.time} onChange={e => setNewResData({...newResData, time: e.target.value})} />
                                        </div>
                                        <div className="flex-1">
                                            <label className="text-[10px] font-bold text-muted uppercase mb-1 block">{TEXT.resPax}</label>
                                            <input type="number" className="w-full bg-bg border border-surface2 p-3 rounded-xl text-white focus:border-accent outline-none" value={newResData.pax} onChange={e => setNewResData({...newResData, pax: e.target.value})} />
                                        </div>
                                    </div>
                                    <div className="flex gap-3">
                                        <div className="flex-1">
                                            <label className="text-[10px] font-bold text-muted uppercase mb-1 block">{TEXT.resTables}</label>
                                            <input className="w-full bg-bg border border-surface2 p-3 rounded-xl text-white focus:border-accent outline-none" value={newResData.tables} onChange={e => setNewResData({...newResData, tables: e.target.value})} />
                                        </div>
                                        <div className="flex-1">
                                            <label className="text-[10px] font-bold text-muted uppercase mb-1 block">{TEXT.resDeposit}</label>
                                            <input type="number" className="w-full bg-bg border border-surface2 p-3 rounded-xl text-white focus:border-accent outline-none" value={newResData.deposit} onChange={e => setNewResData({...newResData, deposit: e.target.value})} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-muted uppercase mb-1 block">{TEXT.resTakenBy}</label>
                                        <input className="w-full bg-bg border border-surface2 p-3 rounded-xl text-white focus:border-accent outline-none" value={newResData.takenBy} onChange={e => setNewResData({...newResData, takenBy: e.target.value})} />
                                    </div>
                                </div>
                                <div className="flex gap-3 mt-8">
                                    <button onClick={()=>setShowResForm(false)} className="flex-1 py-3 text-muted hover:text-white transition">{TEXT.cancel}</button>
                                    <button onClick={saveReservation} className="flex-1 py-3 bg-accent hover:bg-blue-600 text-white rounded-xl font-bold transition shadow-lg">{TEXT.save}</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* ADD TO SLOT MODAL */}
                    {addingToSlot && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={()=>setAddingToSlot(null)}>
                            <div className="bg-surface border border-surface2 rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl" onClick={e=>e.stopPropagation()}>
                                <div className="p-4 border-b border-surface2 flex justify-between items-center">
                                    <span className="font-bold text-white">Dodaj: {addingToSlot.date}</span>
                                    <button onClick={()=>setAddingToSlot(null)} className="text-muted hover:text-white">‚úï</button>
                                </div>
                                <div className="max-h-[60vh] overflow-y-auto p-2 space-y-1">
                                    {people.filter(p => !p.archived).map(p => {
                                        if (addingToSlot.type !== 'bar' && p.role !== 'waiter') return null;
                                        const s = schedule[addingToSlot.date];
                                        if(s && (getBarmanArray(s).includes(p.id) || s.morning.includes(p.id) || s.evening.includes(p.id))) return null;
                                        
                                        const isOff = p.daysOff.includes(addingToSlot.date);
                                        const curH = stats[p.id]?.h || 0;
                                        const addH = addingToSlot.type === 'morning' ? 10 : 12;

                                        return (
                                            <button key={p.id} disabled={isOff}
                                                onClick={()=>{ addToShift(addingToSlot.date, addingToSlot.type, p.id); }} 
                                                className={`w-full text-left px-4 py-3 rounded-xl flex justify-between items-center transition border border-transparent
                                                    ${isOff ? 'opacity-50 cursor-not-allowed' : 'hover:bg-surface2 hover:border-surface2'}
                                                `}>
                                                <div>
                                                    <div className="font-bold text-white flex items-center gap-2">
                                                        {p.name} 
                                                        {p.role==='waiter' && addingToSlot.type==='bar' && <span className="text-[10px] bg-yellow-900/50 text-yellow-200 px-1.5 rounded border border-yellow-700">Zastƒôpstwo</span>}
                                                    </div>
                                                    <div className="text-xs text-muted mt-1">{curH}h <span className="text-accent">‚Üí {curH + addH}h</span></div>
                                                </div>
                                                {isOff ? <span className="text-[10px] text-red-400 font-bold uppercase">Wolne</span> : <span className="text-accent text-xl">+</span>}
                                            </button>
                                        )
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* SETTINGS MODAL */}
                    {showSettings && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={()=>setShowSettings(false)}>
                            <div className="bg-surface border border-surface2 rounded-2xl w-full max-w-md p-6 shadow-2xl" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-white">{TEXT.settingsTitle}</h3>
                                    <button onClick={()=>setShowSettings(false)}><Icons.Close /></button>
                                </div>
                                <div className="flex border-b border-surface2 mb-6">
                                    <button onClick={()=>setSettingsTab('gen')} className={`pb-2 px-4 text-sm font-medium transition border-b-2 ${settingsTab==='gen'?'border-accent text-white':'border-transparent text-muted hover:text-white'}`}>{TEXT.settGen}</button>
                                    <button onClick={()=>setSettingsTab('sys')} className={`pb-2 px-4 text-sm font-medium transition border-b-2 ${settingsTab==='sys'?'border-accent text-white':'border-transparent text-muted hover:text-white'}`}>{TEXT.settSys}</button>
                                </div>

                                {settingsTab === 'gen' ? (
                                    <>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="text-xs font-bold text-muted uppercase mb-1 block">{TEXT.totalStaff}</label>
                                                <input type="number" value={genTotal} onChange={e=>setGenTotal(parseInt(e.target.value))} className="w-full bg-bg border border-surface2 rounded-xl p-3 text-center text-white text-lg focus:border-accent outline-none" />
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-muted uppercase mb-1 block">{TEXT.morningStaff}</label>
                                                <input type="number" value={genMorning} onChange={e=>setGenMorning(parseInt(e.target.value))} className="w-full bg-bg border border-surface2 rounded-xl p-3 text-center text-white text-lg focus:border-accent outline-none" />
                                            </div>
                                        </div>
                                        <div className="flex flex-col gap-3 mt-8">
                                            {isOptimizing ? (
                                                <div className="text-center py-3 text-accent font-mono animate-pulse">{TEXT.optimizing}</div>
                                            ) : (
                                                <div className="flex gap-3">
                                                    <button onClick={()=>runGenerator(false)} className="flex-1 py-3 bg-surface2 hover:bg-bg text-white rounded-xl transition border border-surface2 font-medium">{TEXT.generate}</button>
                                                    <button onClick={()=>runGenerator(true)} className="flex-1 py-3 bg-accent hover:bg-blue-600 text-white rounded-xl transition shadow-lg shadow-blue-900/20 font-medium">{TEXT.optimizeBtn}</button>
                                                </div>
                                            )}
                                        </div>
                                    </>
                                ) : (
                                    <div className="space-y-6">
                                        <div>
                                            <label className="text-xs font-bold text-muted uppercase mb-1 block">{TEXT.headerName}</label>
                                            <input value={appTitle} onChange={e=>saveTitle(e.target.value)} className="w-full bg-bg border border-surface2 rounded-xl p-3 text-white text-sm focus:border-accent outline-none" />
                                        </div>
                                        <div className="pt-4 border-t border-surface2">
                                            {!confirmClean ? (
                                                <button onClick={()=>setConfirmClean(true)} className="w-full py-3 border border-red-500/50 text-red-400 rounded-xl hover:bg-red-500/10 transition">{TEXT.cleanConfirm}</button>
                                            ) : (
                                                <div className="bg-red-900/20 p-4 rounded-xl border border-red-900/50">
                                                    <p className="text-xs text-red-300 mb-3">{TEXT.cleanSub}</p>
                                                    <div className="flex gap-3">
                                                        <button onClick={()=>setConfirmClean(false)} className="flex-1 py-2 bg-bg text-muted rounded-lg text-sm">{TEXT.cancel}</button>
                                                        <button onClick={cleanArchive} className="flex-1 py-2 bg-red-600 text-white rounded-lg text-sm font-bold hover:bg-red-700">{TEXT.cleanBtn}</button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* ARCHIVE CONFIRM */}
                    {personToRemove && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm" onClick={()=>setPersonToRemove(null)}>
                            <div className="bg-surface border border-surface2 rounded-2xl w-full max-w-sm p-6 shadow-2xl text-center" onClick={e=>e.stopPropagation()}>
                                <h3 className="font-bold text-lg text-white mb-2">{TEXT.deleteConfirm}</h3>
                                <p className="text-sm text-muted mb-6">{TEXT.deleteSub}</p>
                                <div className="flex gap-3">
                                    <button onClick={()=>setPersonToRemove(null)} className="flex-1 py-2 bg-surface2 text-white rounded-xl">{TEXT.cancel}</button>
                                    <button onClick={archivePerson} className="flex-1 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700">{TEXT.archive}</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function AuthScreen() {
            const [isReg, setIsReg] = useState(false);
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const [err, setErr] = useState('');
            const [busy, setBusy] = useState(false);

            const handle = async (e) => {
                e.preventDefault(); setBusy(true); setErr('');
                try {
                    if(isReg) await auth.createUserWithEmailAndPassword(email, pass);
                    else await auth.signInWithEmailAndPassword(email, pass);
                } catch(e) { console.error(e); setErr(TEXT.errorAuth); setBusy(false); }
            };

            return (
                <div className="min-h-screen bg-bg flex items-center justify-center p-4 font-sans text-white">
                    <div className="bg-surface border border-surface2 p-8 rounded-3xl shadow-2xl w-full max-w-md relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold tracking-tighter mb-1">KUTER</h1>
                            <p className="text-muted text-sm uppercase tracking-widest">System v0.0.1</p>
                        </div>
                        <form onSubmit={handle} className="space-y-4">
                            <div>
                                <label className="text-[10px] font-bold text-muted uppercase mb-1 block">{TEXT.emailLabel}</label>
                                <input type="email" required className="w-full bg-bg border border-surface2 p-3 rounded-xl focus:border-accent outline-none transition" value={email} onChange={e=>setEmail(e.target.value)} />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-muted uppercase mb-1 block">{TEXT.passLabel}</label>
                                <input type="password" required className="w-full bg-bg border border-surface2 p-3 rounded-xl focus:border-accent outline-none transition" value={pass} onChange={e=>setPass(e.target.value)} />
                            </div>
                            {err && <div className="text-red-400 text-xs bg-red-900/20 p-3 rounded-lg border border-red-900/50 text-center">{err}</div>}
                            <button disabled={busy} className="w-full bg-accent hover:bg-blue-600 text-white py-3.5 rounded-xl font-bold transition shadow-lg shadow-blue-900/20 mt-2 disabled:opacity-50">
                                {busy ? '...' : isReg ? TEXT.btnRegister : TEXT.btnLogin}
                            </button>
                        </form>
                        <div className="mt-8 text-center border-t border-surface2 pt-6">
                            <button onClick={()=>setIsReg(!isReg)} className="text-xs text-muted hover:text-white transition">
                                {isReg ? "Masz ju≈º konto? Zaloguj siƒô" : "Nie masz konta? Zarejestruj siƒô"}
                            </button>
                        </div>
                    </div>
                </div>
            )
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
