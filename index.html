<!DOCTYPE html>
<html lang="pl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KUTER - System Grafik v0.0.9</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bg: '#0f172a',      
                        surface: '#1e293b', 
                        surface2: '#334155', 
                        accent: '#3b82f6',  
                        accentHover: '#2563eb',
                        text: '#e2e8f0',    
                        muted: '#94a3b8',   
                        weekend: '#475569', 
                        danger: '#ef4444',
                        success: '#10b981',
                        warning: '#f59e0b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .loader {
            border: 3px solid #334155;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Error Handler -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Critical Error:", message, lineno);
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDPIZCV4h6Crh254OtZExUaLQtAgjWS1iM",
            authDomain: "grafikmistrz.firebaseapp.com",
            projectId: "grafikmistrz",
            storageBucket: "grafikmistrz.firebasestorage.app",
            messagingSenderId: "605834476831",
            appId: "1:605834476831:web:8da87595b0acb2beb7c42a"
        };

        // Initialize Firebase safely
        let app, auth, db;
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (e) { console.error("Firebase Init Error", e); }

        // --- TEXT CONSTANTS ---
        const TEXT = {
            defaultAppName: "KUTER",
            appSub: "System v0.0.9",
            tabStaff: "Zesp√≥≈Ç",
            tabCalendar: "Grafik",
            tabStats: "Raporty",
            tabReservations: "Rezerwacje",
            secWaiters: "Obs≈Çuga",
            secBartenders: "Bar",
            addBtn: "Dodaj Pracownika",
            copySuccess: "Skopiowano! Wklej (Ctrl+V) w Excelu/Sheets.",
            loading: "≈Åadowanie danych...",
            months: ['Stycze≈Ñ', 'Luty', 'Marzec', 'Kwiecie≈Ñ', 'Maj', 'Czerwiec', 'Lipiec', 'Sierpie≈Ñ', 'Wrzesie≈Ñ', 'Pa≈∫dziernik', 'Listopad', 'Grudzie≈Ñ'],
            daysShort: ['Nd', 'Pn', 'Wt', '≈ör', 'Cz', 'Pt', 'Sb']
        };

        // --- ICONS ---
        const Icons = {
            Menu: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>,
            Close: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
            Users: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            Calendar: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
            Chart: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
            Book: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>,
            Logout: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
            Settings: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
            Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            Check: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
            Plus: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>
        }

        // --- COMPONENTS ---

        function LiveClock() {
            const [time, setTime] = useState(new Date());
            useEffect(() => { const t = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(t); }, []);
            return (
                <div className="flex flex-col items-end">
                    <div className="text-xl md:text-2xl font-bold text-accent font-mono tracking-tighter">
                        {time.toLocaleTimeString('pl-PL', { hour: '2-digit', minute: '2-digit' })}
                    </div>
                    <div className="text-[10px] text-muted uppercase tracking-widest">
                        {time.toLocaleDateString('pl-PL', { day: 'numeric', month: 'short' })}
                    </div>
                </div>
            );
        }

        // --- AUTH SCREEN ---
        function AuthScreen({ onLogin }) {
            const [isReg, setIsReg] = useState(false);
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const [err, setErr] = useState('');
            const [busy, setBusy] = useState(false);

            const handle = async (e) => {
                e.preventDefault(); setBusy(true); setErr('');
                try {
                    if(isReg) await auth.createUserWithEmailAndPassword(email, pass);
                    else await auth.signInWithEmailAndPassword(email, pass);
                } catch(e) { console.error(e); setErr("B≈ÇƒÖd logowania. Sprawd≈∫ dane."); setBusy(false); }
            };

            return (
                <div className="min-h-screen bg-bg flex items-center justify-center p-4 font-sans text-white relative overflow-hidden">
                    <div className="absolute inset-0 z-0 opacity-20 bg-[url('https://images.unsplash.com/photo-1514362545857-3bc16c4c7d1b?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80')] bg-cover bg-center"></div>
                    <div className="bg-surface/90 backdrop-blur-xl border border-surface2 p-8 rounded-3xl shadow-2xl w-full max-w-md relative z-10">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-black tracking-tighter mb-2 bg-gradient-to-r from-blue-400 to-indigo-600 bg-clip-text text-transparent">KUTER</h1>
                            <p className="text-muted text-xs uppercase tracking-[0.3em]">System ZarzƒÖdzania v0.0.9</p>
                        </div>
                        <form onSubmit={handle} className="space-y-4">
                            <div>
                                <label className="text-[10px] font-bold text-muted uppercase mb-1 block pl-1">Email</label>
                                <input type="email" required className="w-full bg-bg/50 border border-surface2 p-3.5 rounded-xl focus:border-accent focus:ring-1 focus:ring-accent outline-none transition text-sm" value={email} onChange={e=>setEmail(e.target.value)} placeholder="login@kuter.pl" />
                            </div>
                            <div>
                                <label className="text-[10px] font-bold text-muted uppercase mb-1 block pl-1">Has≈Ço</label>
                                <input type="password" required className="w-full bg-bg/50 border border-surface2 p-3.5 rounded-xl focus:border-accent focus:ring-1 focus:ring-accent outline-none transition text-sm" value={pass} onChange={e=>setPass(e.target.value)} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                            </div>
                            {err && <div className="text-danger text-xs bg-red-900/10 p-3 rounded-lg border border-red-900/30 text-center font-medium animate-pulse">{err}</div>}
                            <button disabled={busy} className="w-full bg-accent hover:bg-accentHover text-white py-3.5 rounded-xl font-bold transition shadow-lg shadow-blue-900/20 mt-4 disabled:opacity-50 disabled:cursor-not-allowed">
                                {busy ? <span className="inline-block animate-spin mr-2">‚ü≥</span> : null}
                                {busy ? 'Przetwarzanie...' : isReg ? "Zarejestruj siƒô" : "Zaloguj siƒô"}
                            </button>
                        </form>
                        <div className="mt-8 text-center border-t border-surface2 pt-6">
                            <button onClick={()=>setIsReg(!isReg)} className="text-xs text-muted hover:text-white transition underline decoration-dotted underline-offset-4">
                                {isReg ? "Masz ju≈º konto? Zaloguj siƒô" : "Nie masz konta? Utw√≥rz je"}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- MAIN APP COMPONENT ---
        function App() {
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [people, setPeople] = useState([]);
            const [schedule, setSchedule] = useState({});
            const [holidays, setHolidays] = useState([]);
            const [reservations, setReservations] = useState({});
            
            // UI States
            const [activeTab, setActiveTab] = useState('calendar');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [menuOpen, setMenuOpen] = useState(false);
            const [appTitle, setAppTitle] = useState(localStorage.getItem('appTitle') || TEXT.defaultAppName);
            
            // Modals & Forms
            const [modals, setModals] = useState({
                settings: false,
                addStaff: false,
                resForm: false,
                resGrid: false,
                confirmArchive: null, // ID person
                addToSlot: null // {date, type}
            });

            // Form Data
            const [formData, setFormData] = useState({
                staffName: '', staffGender: 'male', staffRole: 'waiter',
                resId: null, resName: '', resTime: '12:00', resPax: 2, resTables: '', resDeposit: 0, resTakenBy: '', resStatus: 'pending',
                genTotal: 4, genMorning: 2
            });

            const [isOptimizing, setIsOptimizing] = useState(false);

            // --- EFFECTS ---
            useEffect(() => { 
                const u = auth.onAuthStateChanged(u => { 
                    setUser(u); 
                    setIsAuthReady(true); 
                    if(!u){ setPeople([]); setSchedule({}); setReservations({}); } 
                }); 
                return () => u(); 
            }, []);

            useEffect(() => {
                if(!user || !db) return;
                const r = `artifacts/${firebaseConfig.projectId}/users/${user.uid}`;
                const unsubs = [
                    db.collection(`${r}/people`).onSnapshot(s => setPeople(s.docs.map(d=>({id:d.id,...d.data()})))),
                    db.doc(`${r}/appData/schedule`).onSnapshot(s => setSchedule(s.data()||{})),
                    db.doc(`${r}/appData/holidays`).onSnapshot(s => setHolidays(s.data()?.dates||[])),
                    db.doc(`${r}/appData/reservations`).onSnapshot(s => setReservations(s.data()||{}))
                ];
                return () => unsubs.forEach(u => u());
            }, [user]);

            // --- HELPERS ---
            const getUserRef = () => `artifacts/${firebaseConfig.projectId}/users/${user.uid}`;
            const getPerson = (id) => people.find(p => p.id === id);
            const getMonthName = (d) => d.toLocaleString('pl-PL', { month: 'long', year: 'numeric' });
            const changeMonth = (delta) => { const n = new Date(currentDate); n.setMonth(n.getMonth()+delta); setCurrentDate(n); };
            const getBarmanArray = (s) => (!s || !s.barman) ? [] : (Array.isArray(s.barman) ? s.barman : [s.barman]);
            const closeModal = (name) => setModals(prev => ({...prev, [name]: false}));
            const openModal = (name, data = null) => {
                if(name === 'confirmArchive') setModals(prev => ({...prev, confirmArchive: data}));
                else if(name === 'addToSlot') setModals(prev => ({...prev, addToSlot: data}));
                else setModals(prev => ({...prev, [name]: true}));
            };

            // --- LOGIC: STATS ---
            const stats = useMemo(() => {
                const s = {}; 
                const dim = new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate();
                people.forEach(p => { s[p.id] = { h: 0, covers: 0, workedDays: 0, off: 0 }; });

                for(let i=1; i<=dim; i++) {
                    const dStr = new Date(currentDate.getFullYear(), currentDate.getMonth(), i).toLocaleDateString('en-CA');
                    const dw = new Date(currentDate.getFullYear(), currentDate.getMonth(), i).getDay();
                    const sh = schedule[dStr];
                    if(sh) {
                        const workersToday = new Set();
                        getBarmanArray(sh).forEach((bid, idx) => {
                            if(s[bid]) {
                                let h = 12; if(dw===5 && idx>0) h=7; else if(dw===0 && idx>0) h=6;
                                s[bid].h += h; workersToday.add(bid);
                                if(getPerson(bid)?.role==='waiter') s[bid].covers++;
                            }
                        });
                        sh.morning.forEach(id=>{ if(s[id]) { s[id].h+=10; workersToday.add(id); }});
                        sh.evening.forEach(id=>{ if(s[id]) { s[id].h+=12; workersToday.add(id); }});
                        workersToday.forEach(pid => { if (s[pid]) s[pid].workedDays++; });
                    }
                }
                Object.keys(s).forEach(pid => { s[pid].off = dim - s[pid].workedDays; });
                return s;
            }, [people, schedule, currentDate]);

            // --- LOGIC: GENERATOR ---
            const runGenerator = async (opt) => {
                if(opt) setIsOptimizing(true);
                setTimeout(async () => {
                    // Simple wrapper for generation logic
                    const gen = (pool, y, m, tot, morn) => {
                        try {
                            const dc = new Date(y, m + 1, 0).getDate();
                            let pList = pool.filter(p => !p.archived).map(p => ({ ...p, hours: 0, streak: 0, barCount: 0 }));
                            const newSched = {};
                            const getScore = (p, r) => { let s = p.hours; if(p.streak >= 4) s += 1000; if(r==='bartender' && p.role==='waiter') s += (p.barCount * 50); return s + Math.random() * 10; };

                            for(let day = 1; day <= dc; day++) {
                                const dStr = new Date(y, m, day).toLocaleDateString('en-CA');
                                const dw = new Date(y, m, day).getDay();
                                const avail = pList.filter(p => !p.daysOff.includes(dStr));
                                // Simplified Logic for demo
                                let sb = []; 
                                let rb = avail.filter(p => p.role === 'bartender').sort((a,b) => getScore(a,'bartender') - getScore(b,'bartender'));
                                const nb = (dw === 5 || dw === 6 || dw === 0) ? 2 : 1;
                                while(sb.length < nb && rb.length) sb.push(rb.shift());
                                
                                // Fill bar gaps with waiters
                                if(sb.length < nb) {
                                    let wb = avail.filter(p => p.role === 'waiter' && !sb.find(x=>x.id===p.id)).sort((a,b) => getScore(a,'bartender') - getScore(b,'bartender'));
                                    while(sb.length < nb && wb.length) { const w = wb.shift(); sb.push(w); pList.find(p => p.id === w.id).barCount++; }
                                }
                                
                                // Waiters logic
                                const bIds = sb.map(b=>b.id);
                                let wc = avail.filter(p => p.role === 'waiter' && !bIds.includes(p.id)).sort((a,b) => getScore(a,'waiter') - getScore(b,'waiter'));
                                let sw = [];
                                while(sw.length < tot && wc.length) sw.push(wc.shift());

                                // Update stats
                                sb.forEach(x => { const p = pList.find(z=>z.id===x.id); p.hours+=12; p.streak++; });
                                sw.forEach(x => { const p = pList.find(z=>z.id===x.id); p.hours+=10.5; p.streak++; });
                                
                                // Reset streak for absent
                                const workingIds = [...bIds, ...sw.map(x=>x.id)];
                                pList.forEach(p => { if(!workingIds.includes(p.id)) p.streak=0; });

                                newSched[dStr] = { barman: bIds, morning: sw.slice(0, morn).map(w=>w.id), evening: sw.slice(morn).map(w=>w.id) };
                            }
                            const hrs = pList.map(p => p.hours);
                            return { schedule: newSched, diff: Math.max(...hrs) - Math.min(...hrs) };
                        } catch(e) { console.error(e); return {schedule:{}, diff:9999}; }
                    };

                    const { genTotal, genMorning } = formData;
                    let best = null; 
                    const iter = opt ? 20 : 1;
                    for(let i=0; i<iter; i++) { 
                        const res = gen(people, currentDate.getFullYear(), currentDate.getMonth(), genTotal, genMorning); 
                        if (!best || res.diff < best.diff) best = res; 
                    }
                    
                    if(best) await db.doc(`${getUserRef()}/appData/schedule`).set(best.schedule, {merge: true});
                    setIsOptimizing(false); closeModal('settings'); setActiveTab('calendar');
                }, 100);
            };

            // --- ACTIONS ---
            const handleAddStaff = async () => {
                if(!formData.staffName.trim()) return;
                await db.collection(`${getUserRef()}/people`).add({ name:formData.staffName.trim(), gender:formData.staffGender, role:formData.staffRole, daysOff:[], archived:false });
                setFormData(prev => ({...prev, staffName: ''})); closeModal('addStaff');
            };
            
            const handleArchiveStaff = async () => {
                if(modals.confirmArchive) await db.doc(`${getUserRef()}/people/${modals.confirmArchive}`).update({archived:true});
                closeModal('confirmArchive');
            };

            const toggleDayOff = async (pid, day) => {
                const p = getPerson(pid); if(!p)return;
                const dStr = new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toLocaleDateString('en-CA');
                const no = p.daysOff.includes(dStr) ? p.daysOff.filter(d=>d!==dStr) : [...p.daysOff, dStr];
                await db.doc(`${getUserRef()}/people/${pid}`).update({daysOff:no});
            };

            const handleReservationSave = async () => {
                if (!formData.resName) return;
                const ds = currentDate.toLocaleDateString('en-CA'); // Note: In real app, this might be separate selectedDate
                const list = reservations[ds] || [];
                let uList;
                if (formData.resId) {
                    uList = list.map(r => r.id === formData.resId ? { ...r, name: formData.resName, time: formData.resTime, pax: formData.resPax, tables: formData.resTables, deposit: formData.resDeposit, takenBy: formData.resTakenBy } : r);
                } else {
                    uList = [...list, { id: Date.now().toString(), name: formData.resName, time: formData.resTime, pax: formData.resPax, tables: formData.resTables, deposit: formData.resDeposit, takenBy: formData.resTakenBy, status: 'pending' }];
                }
                await db.doc(`${getUserRef()}/appData/reservations`).set({ ...reservations, [ds]: uList }, { merge: true });
                closeModal('resForm');
            };
            
            // Clipboard logic
            const copyToClipboard = () => {
                const y = currentDate.getFullYear(), m = currentDate.getMonth();
                const dim = new Date(y, m+1, 0).getDate();
                const monthName = currentDate.toLocaleString('pl-PL', { month: 'long', year: 'numeric' }).toUpperCase();
                
                // HTML Table Construction
                let html = `
                    <table border="1" style="font-family: Arial, sans-serif; border-collapse: collapse; width: 100%;">
                        <thead>
                            <tr style="background-color: #f3f4f6;">
                                <th colspan="5" style="font-size: 16pt; padding: 10px; text-align: center; border: 1px solid #999;">GRAFIK: ${monthName}</th>
                            </tr>
                            <tr style="background-color: #e5e7eb; font-weight: bold;">
                                <th style="padding: 5px; border: 1px solid #999; width: 50px;">Data</th>
                                <th style="padding: 5px; border: 1px solid #999; width: 80px;">Dzie≈Ñ</th>
                                <th style="padding: 5px; border: 1px solid #999; background-color: #dbeafe; color: #1e40af;">Bar</th>
                                <th style="padding: 5px; border: 1px solid #999; background-color: #ffedd5; color: #9a3412;">Rano</th>
                                <th style="padding: 5px; border: 1px solid #999; background-color: #e0f2fe; color: #075985;">Popo≈Çudnie</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for(let d=1; d<=dim; d++){
                    const dObj = new Date(y, m, d);
                    const ds = dObj.toLocaleDateString('en-CA');
                    const dayName = dObj.toLocaleDateString('pl-PL', { weekday: 'long' });
                    const dayShort = dObj.toLocaleDateString('pl-PL', { weekday: 'short' });
                    const isWknd = [0, 5, 6].includes(dObj.getDay()); // Fri, Sat, Sun
                    const s = schedule[ds] || {barman:[], morning:[], evening:[]};
                    const b = getBarmanArray(s).map(id=>getPerson(id)?.name).join(', ');
                    const mr = s.morning.map(id=>getPerson(id)?.name).join(', ');
                    const ev = s.evening.map(id=>getPerson(id)?.name).join(', ');
                    
                    const rowBg = isWknd ? '#e5e7eb' : '#ffffff';

                    html += `
                        <tr style="background-color: ${rowBg};">
                            <td style="padding: 5px; border: 1px solid #ccc; text-align: center; font-weight: bold;">${d}</td>
                            <td style="padding: 5px; border: 1px solid #ccc;">${dayName}</td>
                            <td style="padding: 5px; border: 1px solid #ccc; background-color: #eff6ff; color: #1e3a8a;">${b}</td>
                            <td style="padding: 5px; border: 1px solid #ccc; background-color: #fff7ed; color: #7c2d12;">${mr}</td>
                            <td style="padding: 5px; border: 1px solid #ccc; background-color: #f0f9ff; color: #0c4a6e;">${ev}</td>
                        </tr>
                    `;
                }

                html += `</tbody></table><br/><br/>`;
                
                // Report Section
                html += `
                    <table border="1" style="font-family: Arial, sans-serif; border-collapse: collapse; width: 100%; margin-top: 20px;">
                        <thead>
                            <tr><th colspan="4" style="padding: 8px; background-color: #374151; color: white; text-align: left;">RAPORT MIESIƒòCZNY</th></tr>
                        </thead>
                        <tbody>
                `;

                // Bartenders Report
                html += `<tr><td colspan="4" style="padding: 5px; background-color: #dbeafe; font-weight: bold;">BARMANI</td></tr>`;
                people.filter(p => !p.archived && p.role === 'bartender').forEach(p => {
                     const s = stats[p.id] || {h:0, off:0};
                     html += `<tr>
                        <td style="padding: 5px; border: 1px solid #ccc;">${p.name}</td>
                        <td style="padding: 5px; border: 1px solid #ccc;">Godziny: <b>${s.h}h</b></td>
                        <td style="padding: 5px; border: 1px solid #ccc; color: #dc2626;">Wolne: ${s.off}</td>
                        <td style="padding: 5px; border: 1px solid #ccc;"></td>
                     </tr>`;
                });

                // Waiters Report
                html += `<tr><td colspan="4" style="padding: 5px; background-color: #ffedd5; font-weight: bold;">OBS≈ÅUGA</td></tr>`;
                people.filter(p => !p.archived && p.role === 'waiter').forEach(p => {
                     const s = stats[p.id] || {h:0, off:0, covers:0};
                     html += `<tr>
                        <td style="padding: 5px; border: 1px solid #ccc;">${p.name}</td>
                        <td style="padding: 5px; border: 1px solid #ccc;">Godziny: <b>${s.h}h</b></td>
                        <td style="padding: 5px; border: 1px solid #ccc; color: #dc2626;">Wolne: ${s.off}</td>
                        <td style="padding: 5px; border: 1px solid #ccc; color: #d97706;">Bar zmian: ${s.covers}</td>
                     </tr>`;
                });

                html += `</tbody></table>`;

                const blob = new Blob([html], { type: 'text/html' });
                const blobText = new Blob([html], { type: 'text/plain' });
                const item = new ClipboardItem({ 'text/html': blob, 'text/plain': blobText });

                navigator.clipboard.write([item]).then(() => alert(TEXT.copySuccess)).catch(err => {
                    console.error(err);
                    alert("B≈ÇƒÖd kopiowania (nieobs≈Çugiwane w tej przeglƒÖdarce?)");
                });
            };

            if(!isAuthReady) return <div className="flex h-screen items-center justify-center bg-bg text-text"><div className="loader"></div></div>;
            if(!user) return <AuthScreen />;

            return (
                <div className="min-h-screen flex bg-bg text-text font-sans">
                    {/* SIDEBAR */}
                    <div className={`fixed inset-0 z-50 flex ${menuOpen ? '' : 'pointer-events-none'}`}>
                        <div className={`fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity duration-300 ${menuOpen ? 'opacity-100' : 'opacity-0'}`} onClick={() => setMenuOpen(false)} />
                        <div className={`relative w-72 bg-surface shadow-2xl border-r border-surface2 flex flex-col transform transition-transform duration-300 ${menuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                            <div className="h-24 flex items-center px-6 border-b border-surface2 bg-bg/50">
                                <div className="h-10 w-10 bg-gradient-to-br from-accent to-indigo-600 rounded-xl flex items-center justify-center mr-4 text-white font-bold text-xl shadow-lg shadow-accent/20">K</div>
                                <div>
                                    <h2 className="font-bold text-lg tracking-wide text-white">{appTitle}</h2>
                                    <p className="text-[10px] text-muted uppercase tracking-wider">{TEXT.appSub}</p>
                                </div>
                            </div>
                            <div className="flex-grow py-6 px-3 space-y-1">
                                {[
                                    { id: 'calendar', label: TEXT.tabCalendar, icon: <Icons.Calendar /> },
                                    { id: 'staff', label: TEXT.tabStaff, icon: <Icons.Users /> },
                                    { id: 'reservations', label: TEXT.tabReservations, icon: <Icons.Book /> },
                                    { id: 'stats', label: TEXT.tabStats, icon: <Icons.Chart /> }
                                ].map(item => (
                                    <button key={item.id} onClick={() => { setActiveTab(item.id); setMenuOpen(false); }} className={`w-full flex items-center gap-4 px-4 py-3.5 rounded-xl transition-all duration-200 font-medium ${activeTab === item.id ? 'bg-accent text-white shadow-lg shadow-accent/20' : 'text-muted hover:bg-surface2 hover:text-white'}`}>
                                        {item.icon} <span>{item.label}</span>
                                    </button>
                                ))}
                            </div>
                            <div className="p-6 border-t border-surface2">
                                <button onClick={() => auth.signOut()} className="flex items-center gap-3 text-muted hover:text-danger transition text-sm font-medium w-full px-4 py-2 hover:bg-surface2 rounded-lg">
                                    <Icons.Logout /> Wyloguj
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="flex-grow flex flex-col h-screen overflow-hidden relative">
                        {/* Header */}
                        <header className="h-16 bg-surface/80 backdrop-blur border-b border-surface2 flex items-center justify-between px-4 md:px-8 no-print shrink-0 z-40">
                            <button onClick={() => setMenuOpen(true)} className="p-2 rounded-lg hover:bg-surface2 text-muted hover:text-white transition"><Icons.Menu /></button>
                            <div className="flex items-center gap-6">
                                <div className="hidden md:block text-right border-r border-surface2 pr-6"><LiveClock /></div>
                                <div className="flex items-center bg-surface2 rounded-lg p-0.5">
                                    <button onClick={() => changeMonth(-1)} className="p-1.5 hover:bg-bg rounded text-muted hover:text-white transition">‚óÄ</button>
                                    <span className="px-3 text-sm font-bold min-w-[120px] text-center capitalize">{getMonthName(currentDate)}</span>
                                    <button onClick={() => changeMonth(1)} className="p-1.5 hover:bg-bg rounded text-muted hover:text-white transition">‚ñ∂</button>
                                </div>
                            </div>
                        </header>

                        <div className="flex-grow overflow-y-auto p-4 md:p-8 relative">
                            {/* VIEW: STAFF */}
                            {activeTab === 'staff' && (
                                <div className="max-w-5xl mx-auto space-y-6 animate-in fade-in zoom-in-95 duration-300">
                                    <div className="flex justify-between items-center no-print mb-4">
                                        <h2 className="text-2xl font-bold text-white tracking-tight">{TEXT.tabStaff}</h2>
                                        <button onClick={()=>openModal('addStaff')} className="bg-accent hover:bg-accentHover text-white font-medium px-4 py-2 rounded-xl transition shadow-lg shadow-accent/20 flex items-center gap-2">
                                            <Icons.Plus /> <span className="hidden md:inline">{TEXT.addBtn}</span>
                                        </button>
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        {[TEXT.secWaiters, TEXT.secBartenders].map((title, idx) => {
                                            const role = idx === 0 ? 'waiter' : 'bartender';
                                            return (
                                                <div key={role} className="bg-surface border border-surface2 rounded-2xl overflow-hidden shadow-xl">
                                                    <div className="px-6 py-4 bg-bg/50 border-b border-surface2 font-bold text-muted uppercase tracking-wider text-xs flex justify-between">
                                                        <span>{title}</span>
                                                        <span className="bg-surface2 px-2 rounded text-white">{people.filter(p => p.role === role && !p.archived).length}</span>
                                                    </div>
                                                    <div className="p-4 space-y-3">
                                                        {people.filter(p => p.role === role && !p.archived).map(p => (
                                                            <div key={p.id} className="bg-bg border border-surface2 rounded-xl p-3 hover:border-surface2/80 transition group relative">
                                                                <div className="flex justify-between items-center mb-3">
                                                                    <div className="font-bold text-white flex items-center gap-3">
                                                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-lg ${p.gender === 'male' ? 'bg-blue-900/30' : 'bg-pink-900/30'}`}>{p.gender === 'male' ? 'üë®' : 'üë©'}</div>
                                                                        {p.name}
                                                                    </div>
                                                                    <button onClick={()=>openModal('confirmArchive', p.id)} className="text-surface2 hover:text-danger transition no-print opacity-0 group-hover:opacity-100 p-2 rounded hover:bg-surface2"><Icons.Trash /></button>
                                                                </div>
                                                                <div className="flex flex-wrap gap-1 no-print">
                                                                    {Array.from({length: new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate()}, (_, i)=>i+1).map(d => {
                                                                        const dObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), d);
                                                                        const dStr = dObj.toLocaleDateString('en-CA');
                                                                        const isOff = p.daysOff.includes(dStr);
                                                                        const isWknd = [0, 5, 6].includes(dObj.getDay());
                                                                        return (
                                                                            <button key={d} onClick={()=>toggleDayOff(p.id, d)} 
                                                                                className={`w-7 h-7 text-[10px] rounded transition-all border ${
                                                                                    isOff ? 'bg-danger/20 text-danger border-danger/40' : 
                                                                                    isWknd ? 'bg-weekend/20 text-muted border-transparent hover:bg-accent hover:text-white' : 
                                                                                    'bg-surface2/50 text-muted border-transparent hover:bg-accent hover:text-white'
                                                                                }`}>
                                                                                {d}
                                                                            </button>
                                                                        )
                                                                    })}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                    <div className="fixed bottom-6 right-6 no-print z-30">
                                        <button onClick={()=>openModal('settings')} className="bg-surface hover:bg-surface2 text-white h-14 w-14 rounded-full shadow-2xl border border-surface2 flex items-center justify-center text-2xl transition transform hover:scale-110 group">
                                            <div className="group-hover:rotate-90 transition duration-500"><Icons.Settings /></div>
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* VIEW: CALENDAR */}
                            {activeTab === 'calendar' && (
                                <div className="max-w-full mx-auto animate-in fade-in slide-in-from-bottom-4 duration-300">
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="text-2xl font-bold text-white tracking-tight">{TEXT.tabCalendar}</h2>
                                        <button onClick={copyToClipboard} className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl text-sm font-bold transition shadow-lg shadow-emerald-900/20 flex items-center gap-2">
                                            üìã <span className="hidden md:inline">Eksport</span>
                                        </button>
                                    </div>
                                    <div className="bg-surface border border-surface2 rounded-2xl overflow-hidden shadow-xl overflow-x-auto">
                                        <table className="w-full text-left border-collapse min-w-[800px]">
                                            <thead>
                                                <tr className="text-xs uppercase text-muted tracking-wider border-b border-surface2 bg-bg/50">
                                                    <th className="p-4 font-bold w-24 border-r border-surface2 text-center">Data</th>
                                                    <th className="p-4 font-bold w-1/4 border-r border-surface2 text-indigo-400">Bar</th>
                                                    <th className="p-4 font-bold w-1/3 border-r border-surface2 text-orange-400">Rano</th>
                                                    <th className="p-4 font-bold w-1/3 text-blue-400">Popo≈Çudnie</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-surface2 text-sm">
                                                {Array.from({length: new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate()}, (_, i)=>i+1).map(d => {
                                                    const dObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), d);
                                                    const dStr = dObj.toLocaleDateString('en-CA');
                                                    const isHol = holidays.includes(dStr);
                                                    const isWknd = [0, 6].includes(dObj.getDay());
                                                    const s = schedule[dStr] || { barman: [], morning: [], evening: [] };
                                                    
                                                    const Badge = ({uid, t, onDelete}) => {
                                                        const p = getPerson(uid); if(!p)return null;
                                                        const color = t==='bar' ? 'bg-indigo-500/20 text-indigo-300 border-indigo-500/30' : t==='morning' ? 'bg-orange-500/20 text-orange-300 border-orange-500/30' : 'bg-blue-500/20 text-blue-300 border-blue-500/30';
                                                        return (
                                                            <span className={`inline-flex items-center px-2 py-1 rounded-md text-xs font-medium border mr-1.5 mb-1.5 ${color}`}>
                                                                {p.name}
                                                                <button onClick={onDelete} className="ml-1.5 hover:text-white opacity-60 hover:opacity-100 transition">√ó</button>
                                                            </span>
                                                        )
                                                    };

                                                    return (
                                                        <tr key={d} className={`group hover:bg-surface2/20 transition ${isHol ? 'bg-danger/5' : isWknd ? 'bg-surface2/5' : ''}`}>
                                                            <td className="p-3 border-r border-surface2 relative text-center align-top">
                                                                <div className="font-black text-xl text-white/90">{d}</div>
                                                                <div className="text-[10px] text-muted uppercase font-bold">{TEXT.daysShort[dObj.getDay()]}</div>
                                                                <button onClick={async()=>{
                                                                    const nh = isHol ? holidays.filter(x=>x!==dStr) : [...holidays, dStr];
                                                                    await db.doc(`${getUserRef()}/appData/holidays`).set({dates:nh});
                                                                }} className={`absolute top-2 right-2 text-xs opacity-0 group-hover:opacity-100 transition ${isHol ? 'text-warning opacity-100' : 'text-surface2 hover:text-warning'}`}>‚òÖ</button>
                                                            </td>
                                                            {['bar', 'morning', 'evening'].map(t => (
                                                                <td key={t} className="p-2 border-r border-surface2 last:border-0 align-top relative group/cell">
                                                                    <div className="min-h-[40px] flex flex-wrap content-start items-center">
                                                                        {(t==='bar'?getBarmanArray(s):s[t]).map(id => <Badge key={id} uid={id} t={t} onDelete={async()=>{
                                                                            const ns={...s};
                                                                            if(t==='bar'){ const b=getBarmanArray(s); ns.barman=b.filter(x=>x!==id); } else ns[t]=s[t].filter(x=>x!==id);
                                                                            await db.doc(`${getUserRef()}/appData/schedule`).update({[dStr]:ns});
                                                                        }} />)}
                                                                        <button onClick={()=>openModal('addToSlot', {date:dStr, type:t})} className="w-6 h-6 rounded flex items-center justify-center text-surface2 hover:bg-accent hover:text-white transition opacity-0 group-hover/cell:opacity-100 ml-1">+</button>
                                                                    </div>
                                                                </td>
                                                            ))}
                                                        </tr>
                                                    )
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {/* VIEW: STATS */}
                            {activeTab === 'stats' && (
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-300 max-w-6xl mx-auto">
                                    <h2 className="text-2xl font-bold text-white mb-6">{TEXT.tabStats}</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        {[TEXT.secWaiters, TEXT.secBartenders].map((title, idx) => {
                                            const role = idx === 0 ? 'waiter' : 'bartender';
                                            const list = people.filter(p => p.role === role && (!p.archived || stats[p.id]?.h > 0)).sort((a,b) => stats[b.id].h - stats[a.id].h);
                                            const maxH = Math.max(...list.map(p=>stats[p.id].h), 1);
                                            return (
                                                <div key={role} className="bg-surface border border-surface2 rounded-2xl p-6 shadow-xl">
                                                    <h3 className="text-sm font-bold text-muted uppercase tracking-wider mb-6 border-b border-surface2 pb-2">{title}</h3>
                                                    <div className="space-y-5">
                                                        {list.map(p => {
                                                            const s = stats[p.id];
                                                            return (
                                                                <div key={p.id}>
                                                                    <div className="flex justify-between items-end mb-1">
                                                                        <span className={`font-bold ${p.archived?'line-through text-muted':'text-white'}`}>{p.name}</span>
                                                                        <div className="text-xs text-muted flex gap-3">
                                                                            <span className="text-accent font-mono">{s.h}h</span>
                                                                            <span>Wolne: <b className="text-danger">{s.off}</b></span>
                                                                            {role==='waiter' && s.covers>0 && <span className="text-warning">Bar: {s.covers}</span>}
                                                                        </div>
                                                                    </div>
                                                                    <div className="w-full bg-bg h-2.5 rounded-full overflow-hidden">
                                                                        <div className={`h-full rounded-full ${role==='waiter'?'bg-accent':'bg-indigo-500'}`} style={{width: `${(s.h/maxH)*100}%`}}></div>
                                                                    </div>
                                                                </div>
                                                            )
                                                        })}
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* VIEW: RESERVATIONS */}
                            {activeTab === 'reservations' && (
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-300 max-w-4xl mx-auto space-y-6">
                                    <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-surface p-6 rounded-2xl border border-surface2 shadow-lg">
                                        <h2 className="text-xl font-bold text-white">
                                            {currentDate.toLocaleDateString('pl-PL', {weekday:'long', day:'numeric', month:'long'})}
                                        </h2>
                                        <div className="flex gap-2 w-full md:w-auto">
                                            <button onClick={()=>{
                                                setFormData({resId:null, resName:'', resTime:'12:00', resPax:2, resTables:'', resDeposit:0, resTakenBy:'', resStatus:'pending'});
                                                openModal('resForm');
                                            }} className="flex-1 md:flex-none bg-accent hover:bg-accentHover text-white px-4 py-2 rounded-xl font-bold transition shadow-lg shadow-accent/20">+ Rezerwacja</button>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-3">
                                        {(reservations[currentDate.toLocaleDateString('en-CA')] || []).sort((a,b)=>a.time.localeCompare(b.time)).map(r => (
                                            <div key={r.id} onClick={()=>{
                                                setFormData({resId:r.id, resName:r.name, resTime:r.time, resPax:r.pax, resTables:r.tables, resDeposit:r.deposit, resTakenBy:r.takenBy, resStatus:r.status});
                                                openModal('resForm');
                                            }} className={`bg-surface border border-surface2 p-4 rounded-xl flex flex-col md:flex-row items-center gap-4 cursor-pointer hover:border-accent transition group relative overflow-hidden ${r.status==='done'?'opacity-60':''}`}>
                                                <div className={`absolute left-0 top-0 bottom-0 w-1 ${r.status==='done'?'bg-success':r.status==='cancelled'?'bg-danger':'bg-warning'}`}></div>
                                                <div className="font-mono text-2xl font-bold text-white w-20 text-center">{r.time}</div>
                                                <div className="flex-grow text-center md:text-left">
                                                    <div className="font-bold text-lg text-white">{r.name}</div>
                                                    <div className="text-sm text-muted flex flex-wrap gap-x-4 gap-y-1 justify-center md:justify-start">
                                                        <span>üë• {r.pax} os.</span>
                                                        <span>ü™ë {r.tables || 'Brak sto≈Çu'}</span>
                                                        {r.deposit > 0 && <span className="text-success font-bold">üí∞ {r.deposit} PLN</span>}
                                                        <span>üìù {r.takenBy}</span>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2" onClick={e=>e.stopPropagation()}>
                                                    <button onClick={async()=>{
                                                        const ds = currentDate.toLocaleDateString('en-CA');
                                                        const list = reservations[ds]||[];
                                                        const stat = r.status==='pending'?'done':r.status==='done'?'cancelled':'pending';
                                                        await db.doc(`${getUserRef()}/appData/reservations`).update({[ds]: list.map(x=>x.id===r.id?{...x,status:stat}:x)});
                                                    }} className={`px-3 py-1 rounded text-xs font-bold uppercase border ${r.status==='done'?'text-success border-success':'text-muted border-surface2 hover:border-white'}`}>
                                                        {r.status==='done'?'OK':r.status==='cancelled'?'Anul':'Oczekuje'}
                                                    </button>
                                                    <button onClick={async()=>{
                                                        if(!confirm('UsunƒÖƒá?'))return;
                                                        const ds = currentDate.toLocaleDateString('en-CA');
                                                        await db.doc(`${getUserRef()}/appData/reservations`).update({[ds]: (reservations[ds]||[]).filter(x=>x.id!==r.id)});
                                                    }} className="p-2 text-surface2 hover:text-danger"><Icons.Trash /></button>
                                                </div>
                                            </div>
                                        ))}
                                        {!(reservations[currentDate.toLocaleDateString('en-CA')] || []).length && (
                                            <div className="text-center py-12 text-muted italic border-2 border-dashed border-surface2 rounded-xl">Brak rezerwacji na ten dzie≈Ñ</div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* --- MODALS --- */}
                    
                    {/* Add Staff Modal */}
                    {modals.addStaff && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in duration-200" onClick={()=>closeModal('addStaff')}>
                            <div className="bg-surface border border-surface2 rounded-2xl w-full max-w-sm p-6 shadow-2xl scale-100" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-white mb-6">{TEXT.addBtn}</h3>
                                <div className="space-y-4">
                                    <input value={formData.staffName} onChange={e=>setFormData({...formData, staffName:e.target.value})} placeholder="Imiƒô i Nazwisko" className="w-full bg-bg border border-surface2 rounded-xl px-4 py-3 focus:border-accent outline-none text-white" autoFocus />
                                    <div className="flex gap-2">
                                        <select value={formData.staffGender} onChange={e=>setFormData({...formData, staffGender:e.target.value})} className="bg-bg border border-surface2 rounded-xl px-4 py-3 outline-none text-white flex-1"><option value="male">Ch≈Çopak</option><option value="female">Dziewczyna</option></select>
                                        <select value={formData.staffRole} onChange={e=>setFormData({...formData, staffRole:e.target.value})} className="bg-bg border border-surface2 rounded-xl px-4 py-3 outline-none text-white flex-1"><option value="waiter">Kelner</option><option value="bartender">Barman</option></select>
                                    </div>
                                    <button onClick={handleAddStaff} className="w-full py-3 bg-accent hover:bg-accentHover text-white rounded-xl font-bold mt-2">Zapisz</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Reservation Modal */}
                    {modals.resForm && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in duration-200" onClick={()=>closeModal('resForm')}>
                            <div className="bg-surface border border-surface2 rounded-2xl w-full max-w-md p-6 shadow-2xl" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-white mb-6">Rezerwacja</h3>
                                <div className="space-y-4">
                                    <input className="w-full bg-bg border border-surface2 p-3 rounded-xl text-white outline-none focus:border-accent" placeholder="Nazwisko" value={formData.resName} onChange={e=>setFormData({...formData, resName:e.target.value})} autoFocus />
                                    <div className="flex gap-3">
                                        <input type="time" className="flex-1 bg-bg border border-surface2 p-3 rounded-xl text-white outline-none focus:border-accent" value={formData.resTime} onChange={e=>setFormData({...formData, resTime:e.target.value})} />
                                        <input type="number" className="flex-1 bg-bg border border-surface2 p-3 rounded-xl text-white outline-none focus:border-accent" placeholder="Os√≥b" value={formData.resPax} onChange={e=>setFormData({...formData, resPax:e.target.value})} />
                                    </div>
                                    <div className="flex gap-3">
                                        <input className="flex-1 bg-bg border border-surface2 p-3 rounded-xl text-white outline-none focus:border-accent" placeholder="Stolik" value={formData.resTables} onChange={e=>setFormData({...formData, resTables:e.target.value})} />
                                        <input type="number" className="flex-1 bg-bg border border-surface2 p-3 rounded-xl text-white outline-none focus:border-accent" placeholder="Zadatek" value={formData.resDeposit} onChange={e=>setFormData({...formData, resDeposit:e.target.value})} />
                                    </div>
                                    <input className="w-full bg-bg border border-surface2 p-3 rounded-xl text-white outline-none focus:border-accent" placeholder="Kto przyjƒÖ≈Ç" value={formData.resTakenBy} onChange={e=>setFormData({...formData, resTakenBy:e.target.value})} />
                                    <button onClick={handleReservationSave} className="w-full py-3 bg-accent hover:bg-accentHover text-white rounded-xl font-bold mt-2">Zapisz</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Add To Slot Modal */}
                    {modals.addToSlot && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in duration-200" onClick={()=>closeModal('addToSlot')}>
                            <div className="bg-surface border border-surface2 rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl" onClick={e=>e.stopPropagation()}>
                                <div className="p-4 border-b border-surface2 flex justify-between items-center bg-bg">
                                    <span className="font-bold text-white">Dodaj do zmiany</span>
                                    <button onClick={()=>closeModal('addToSlot')}><Icons.Close /></button>
                                </div>
                                <div className="max-h-[60vh] overflow-y-auto p-2 space-y-1">
                                    {people.filter(p => !p.archived).map(p => {
                                        if (modals.addToSlot.type !== 'bar' && p.role !== 'waiter') return null;
                                        const s = schedule[modals.addToSlot.date];
                                        if(s && (getBarmanArray(s).includes(p.id) || s.morning.includes(p.id) || s.evening.includes(p.id))) return null;
                                        const isOff = p.daysOff.includes(modals.addToSlot.date);
                                        
                                        // Calculate Hours Prediction
                                        const curH = stats[p.id]?.h || 0;
                                        const estH = modals.addToSlot.type === 'morning' ? 10 : 12;
                                        
                                        return (
                                            <button key={p.id} disabled={isOff} onClick={async ()=>{
                                                const dStr = modals.addToSlot.date; const type = modals.addToSlot.type;
                                                const prevS = schedule[dStr]||{date:dStr,morning:[],evening:[],barman:[]};
                                                const ns={...prevS};
                                                if(type==='bar'){ const b=getBarmanArray(prevS); ns.barman=[...b,p.id]; } else ns[type]=[...ns[type]||[], p.id];
                                                await db.doc(`${getUserRef()}/appData/schedule`).set({[dStr]:ns}, {merge:true});
                                                closeModal('addToSlot');
                                            }} className={`w-full text-left px-4 py-3 rounded-xl flex justify-between items-center transition border border-transparent ${isOff ? 'opacity-40 grayscale cursor-not-allowed' : 'hover:bg-surface2 hover:border-surface2'}`}>
                                                <div>
                                                    <span className="font-bold text-white block">{p.name}</span>
                                                    {!isOff && <span className="text-[10px] text-muted">{curH}h <span className="text-accent">‚Üí {curH + estH}h</span></span>}
                                                </div>
                                                {isOff && <span className="text-xs text-danger uppercase font-bold">Wolne</span>}
                                            </button>
                                        )
                                    })}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Settings Modal */}
                    {modals.settings && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-in fade-in duration-200" onClick={()=>closeModal('settings')}>
                            <div className="bg-surface border border-surface2 rounded-2xl w-full max-w-md p-6 shadow-2xl" onClick={e=>e.stopPropagation()}>
                                <h3 className="text-xl font-bold text-white mb-6">Ustawienia</h3>
                                <div className="space-y-6">
                                    <div>
                                        <label className="text-xs font-bold text-muted uppercase mb-1 block">Nazwa Lokalu</label>
                                        <input value={appTitle} onChange={e=>{setAppTitle(e.target.value); localStorage.setItem('appTitle', e.target.value);}} className="w-full bg-bg border border-surface2 rounded-xl p-3 text-white outline-none focus:border-accent" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-muted uppercase mb-1 block">Kelner√≥w ≈ÅƒÖcznie</label>
                                            <input type="number" value={formData.genTotal} onChange={e=>setFormData({...formData, genTotal:parseInt(e.target.value)})} className="w-full bg-bg border border-surface2 rounded-xl p-3 text-white text-center font-bold" />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-muted uppercase mb-1 block">Rano</label>
                                            <input type="number" value={formData.genMorning} onChange={e=>setFormData({...formData, genMorning:parseInt(e.target.value)})} className="w-full bg-bg border border-surface2 rounded-xl p-3 text-white text-center font-bold" />
                                        </div>
                                    </div>
                                    <div className="flex gap-3 pt-4 border-t border-surface2">
                                        {isOptimizing ? <div className="w-full py-3 text-center text-accent font-mono animate-pulse">Optymalizacja...</div> : (
                                            <>
                                                <button onClick={()=>runGenerator(false)} className="flex-1 py-3 bg-surface2 hover:bg-bg text-white rounded-xl transition">Generuj Szybko</button>
                                                <button onClick={()=>runGenerator(true)} className="flex-1 py-3 bg-accent hover:bg-accentHover text-white rounded-xl transition shadow-lg">Optymalizuj</button>
                                            </>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
